{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}" />
    <title>BugBounty Arsenal UI</title>
    <script src="{% static 'js/api-client.js' %}"></script>
    <script>
        // Django URLs configuration
        window.URLS = {
            adminPanel: '{% url "admin-panel" %}',
            landingPricing: '{% url "landing" %}#pricing'
        };
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #050816;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
        }
        header {
            padding: 1.5rem 2rem;
            background: linear-gradient(90deg, #0f172a, #111827);
            border-bottom: 1px solid #1f2937;
        }
        h1 {
            margin: 0;
            font-size: 1.6rem;
        }
        main {
            display: flex;
            gap: 2rem;
            padding: 2rem;
        }
        .card {
            background: #0b1120;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
        }
        .card h2 {
            margin-top: 0;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        form label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            color: #9ca3af;
        }
        form input[type="text"],
        form select {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            margin-bottom: 0.75rem;
        }
        form input[type="text"]:focus,
        form select:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
        }
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1.2rem;
            border-radius: 0.5rem;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #111827;
        }
        th {
            text-align: left;
            color: #9ca3af;
            font-weight: 500;
        }
        tr:hover td {
            background: rgba(15, 23, 42, 0.7);
        }
        a.report-link {
            color: #38bdf8;
            text-decoration: none;
        }
        a.report-link:hover {
            text-decoration: underline;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 0.1rem 0.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
        }
        .status-running {
            background: rgba(34, 197, 94, 0.15);
            color: #86efac;
        }
        .status-completed {
            background: rgba(100, 116, 139, 0.15);
            color: #94a3b8;
        }
        .scan-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            border-left: 3px solid #22c55e;
        }
        .scan-item.completed {
            border-left-color: #64748b;
        }
        .btn-log {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 0.3rem;
            background: rgba(56, 189, 248, 0.15);
            color: #38bdf8;
            text-decoration: none;
            margin-left: 0.5rem;
        }
        .btn-log:hover {
            background: rgba(56, 189, 248, 0.25);
        }
        .btn-stop {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 0.3rem;
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            text-decoration: none;
            margin-left: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .btn-stop:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        @media (max-width: 900px) {
            main {
                flex-direction: column;
            }
        }
        .status-bar {
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .progress-container {
            margin-top: 0.5rem;
            width: 100%;
            background: #020617;
            border-radius: 999px;
            border: 1px solid #1f2937;
            overflow: hidden;
            height: 8px;
        }
        .progress-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.2s ease-out;
        }
        .dot-spinner {
            display: inline-block;
            width: 32px;
            text-align: center;
        }
        .dot-spinner span {
            display: inline-block;
            width: 4px;
            height: 4px;
            margin: 0 1px;
            border-radius: 999px;
            background: #22c55e;
            opacity: 0.3;
            animation: pulse 1.2s infinite ease-in-out;
        }
        .dot-spinner span:nth-child(2) { animation-delay: 0.2s; }
        .dot-spinner span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-3px); }
        }
        
        @keyframes progress-slide {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }
        
        .progress-bar-animation {
            animation: progress-slide 2s linear infinite;
        }
    </style>
</head>
<body>
<header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>BugBounty Arsenal v2.0 ‚Äì UI</h1>
            <div style="font-size: 0.85rem; color: #9ca3af; margin-top: 0.25rem;">
                Fast async scanner ‚Ä¢ recon + standard mode ‚Ä¢ reports overview
            </div>
        </div>
        <div style="text-align: right;">
            <span class="tag" style="background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; padding: 0.3rem 0.8rem; font-size: 0.85rem; margin-bottom: 0.25rem; display: inline-block;">
                {{ tier_info.name }} PLAN
            </span>
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.5rem;">
                {{ tier_info.concurrent_scans }} scans ‚Ä¢ {{ tier_info.max_urls }} URLs ‚Ä¢ {{ tier_info.detectors }}
            </div>
            
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-bottom: 0.5rem;">
                {% if is_superuser %}
                <!-- Admin Panel Button (Superuser Only) -->
                <button onclick="window.location.href=window.URLS.adminPanel" 
                        style="padding: 0.4rem 0.8rem; font-size: 0.75rem; border-radius: 0.4rem; border: 1px solid #dc2626; background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; cursor: pointer; font-weight: 600;">
                    üõ°Ô∏è Admin Panel
                </button>
                {% endif %}
                
                {% if tier != 'free' %}
                <!-- Manage Subscription Button for Paid Users -->
                <button onclick="openBillingPortal()" 
                        style="padding: 0.4rem 0.8rem; font-size: 0.75rem; border-radius: 0.4rem; border: 1px solid #7c3aed; background: transparent; color: #a855f7; cursor: pointer;">
                    ‚öôÔ∏è Manage Subscription
                </button>
                {% else %}
                <!-- Upgrade Button for Free Users -->
                <button onclick="window.location.href=window.URLS.landingPricing" 
                        style="padding: 0.4rem 0.8rem; font-size: 0.75rem; border-radius: 0.4rem; border: 1px solid #22c55e; background: #22c55e; color: white; cursor: pointer;">
                    ‚¨ÜÔ∏è Upgrade Plan
                </button>
                {% endif %}
            </div>
            
            <!-- Tier Switcher (for testing only) -->
            <div style="display: flex; gap: 0.25rem; justify-content: flex-end;">
                <button onclick="changeTier('free')" style="padding: 0.15rem 0.4rem; font-size: 0.65rem; border-radius: 0.3rem; border: 1px solid #374151; background: {% if tier == 'free' %}#22c55e{% else %}#020617{% endif %}; color: white; cursor: pointer;">FREE</button>
                <button onclick="changeTier('pro')" style="padding: 0.15rem 0.4rem; font-size: 0.65rem; border-radius: 0.3rem; border: 1px solid #374151; background: {% if tier == 'pro' %}#22c55e{% else %}#020617{% endif %}; color: white; cursor: pointer;">PRO</button>
                <button onclick="changeTier('enterprise')" style="padding: 0.15rem 0.4rem; font-size: 0.65rem; border-radius: 0.3rem; border: 1px solid #374151; background: {% if tier == 'enterprise' %}#22c55e{% else %}#020617{% endif %}; color: white; cursor: pointer;">ENT</button>
            </div>
        </div>
    </div>
</header>

<main>
    <section class="card" style="flex: 0 0 320px;">
        <h2>Start New Scan</h2>
        
        <!-- Scan Usage Counter -->
        {% if scan_stats and tier != 'enterprise' %}
        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15)); border: 1px solid rgba(34, 197, 94, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <div style="font-size: 0.9rem; font-weight: 600; color: #22c55e;">Daily Scans</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #22c55e;">
                    {{ scan_stats.daily_used }}/{{ scan_stats.daily_limit }}
                </div>
            </div>
            
            <!-- Progress bar -->
            <div style="background: rgba(15, 23, 42, 0.5); height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #22c55e, #16a34a); height: 100%; width: {{ scan_stats.daily_percentage }}%; transition: width 0.3s;"></div>
            </div>
            
            {% if scan_stats.extra_scans_available > 0 %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(34, 197, 94, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.8rem; color: #9ca3af;">Extra Scans</div>
                    <div style="font-size: 1rem; font-weight: 600; color: #a855f7;">
                        {{ scan_stats.extra_scans_available }} available
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if scan_stats.daily_used >= scan_stats.daily_limit %}
            <div style="margin-top: 0.75rem;">
                <button onclick="showBuyExtraScans()" style="width: 100%; padding: 0.6rem; font-size: 0.85rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);">
                    üíé Buy Extra Scans
                </button>
            </div>
            {% endif %}
        </div>
        {% elif tier == 'enterprise' %}
        <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(124, 58, 237, 0.15)); border: 1px solid rgba(168, 85, 247, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 0.75rem; text-align: center;">
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ôæÔ∏è</div>
            <div style="font-size: 0.9rem; font-weight: 600; color: #a855f7;">Unlimited Scans</div>
            <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">ENTERPRISE Plan</div>
        </div>
        {% endif %}
        
        <!-- Tier Limits Notice -->
        <div style="background: rgba(168, 85, 247, 0.1); border-left: 3px solid #a855f7; padding: 0.75rem; margin-bottom: 1rem; border-radius: 0.5rem;">
            <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem;">{{ tier_info.name }} Limits:</div>
            <div style="font-size: 0.75rem; color: #9ca3af;">
                ‚Ä¢ Max {{ tier_limits.max_concurrent_scans }} concurrent scan(s)<br>
                ‚Ä¢ Up to {{ tier_info.max_urls }} URLs per scan<br>
                ‚Ä¢ Recon pipeline: {{ tier_info.recon_pipeline }}<br>
                ‚Ä¢ Nuclei CVE scans: {{ tier_info.nuclei }}
            </div>
        </div>
        
        <form id="scanForm" method="post">
            {% csrf_token %}
            <label for="target">Target URL or Domain</label>
            <input type="text" id="target" name="target" placeholder="https://example.com or example.com" required style="margin-bottom: 1rem;" />
            
            <label for="scan_intensity">Scan Intensity</label>
            <select id="scan_intensity" name="scan_intensity" style="margin-bottom: 1rem;">
                <option value="quick">‚ö° Quick Scan (Fast, basic checks)</option>
                <option value="standard" selected>üîç Standard Scan (Balanced)</option>
                <option value="deep">üî¨ Deep Scan (Thorough, slower)</option>
                {% if tier_limits.is_pro_or_enterprise %}
                <option value="brutal">üíÄ Brutal Scan (Maximum depth - PRO/ENTERPRISE)</option>
                {% endif %}
            </select>
                <div style="color: #9ca3af;">
                    ‚Ä¢ <span style="color: #22c55e;"><span id="in-scope-count">0</span> in-scope</span> domains<br>
                    ‚Ä¢ <span style="color: #ef4444;"><span id="out-scope-count">0</span> out-of-scope</span> domains

            <button type="submit" class="btn-primary" id="start-scan-btn">Start Scan</button>
        </form>
        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.75rem;">
            The scan runs in the background with all 39 detectors (30 active + 9 passive)
        </p>

        <div style="margin-top: 1.5rem;">
            <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Active Scans</h3>
            
            <!-- Error message placeholder -->
            <div id="error-message" style="display: none; background: rgba(239, 68, 68, 0.15); border-left: 3px solid #ef4444; padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 0.5rem; color: #fca5a5; font-size: 0.8rem;"></div>
            
            <div id="active-scans-list">
                {% if active_scans %}
                    {% for scan in active_scans %}
                    <div class="scan-item scan-card-{{scan.id}}" data-scan-id="{{scan.id}}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <strong>{{ scan.target }}</strong>
                                <span class="tag scan-status-{{scan.id}} {% if scan.status == 'running' %}status-running{% elif scan.status == 'completed' %}status-completed{% elif scan.status == 'failed' %}status-failed{% else %}status-pending{% endif %}">
                                    {{ scan.status }}
                                </span>
                            </div>
                            <div>
                                {% if scan.report_path %}
                                <a href="/media/{{ scan.report_path }}" target="_blank" class="btn-log">view report</a>
                                {% endif %}
                                {% if scan.status == 'running' %}
                                <button onclick="stopScan('{{ scan.id }}')" class="btn-stop">stop</button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Progress Bar (only for running/pending scans) -->
                        {% if scan.status in 'running,pending' %}
                        <div class="progress-container" style="margin: 0.5rem 0;">
                            <div class="progress-bar" style="background: rgba(15, 23, 42, 0.7); border-radius: 0.5rem; height: 24px; position: relative; overflow: hidden;">
                                <div class="progress-fill scan-progress-{{scan.id}}" style="background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); height: 100%; width: {{scan.progress|default:0}}%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem;">
                                    <span class="progress-text scan-progress-text-{{scan.id}}" style="position: absolute; width: 100%; text-align: center; font-size: 0.75rem; font-weight: 600; color: #fff; z-index: 2;">{{scan.progress|default:0}}%</span>
                                </div>
                            </div>
                            <div class="progress-step scan-step-{{scan.id}}" style="font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;">
                                {{scan.current_step|default:"Initializing..."}}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; display: flex; justify-content: space-between;">
                            <span>Started: {{ scan.started_at|date:"Y-m-d H:i:s"|default:"Not started" }}</span>
                            {% if scan.vulnerabilities_found > 0 %}
                            <span style="color: #ef4444; font-weight: 600;">üî¥ {{scan.vulnerabilities_found}} vulnerabilities found</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #6b7280; font-size: 0.8rem;">No active scans.</p>
                {% endif %}
            </div>
        </div>
    </section>

    <section class="card" style="flex: 1 1 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Available Reports</h2>
            <button onclick="toggleDetectorsList()" class="btn-log" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                View Enabled Detectors ({{ tier_info.detectors }})
            </button>
        </div>
        
        <!-- Collapsible Detectors List -->
        <div id="detectors-list" style="display: none; background: rgba(15, 23, 42, 0.7); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; max-height: 200px; overflow-y: auto;">
            <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: #38bdf8;">Active Detectors for {{ tier_info.name }} Plan:</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.75rem; color: #9ca3af;">
                {% for detector in tier_limits.allowed_detectors %}
                <div>‚úì {{ detector|title }}</div>
                {% endfor %}
            </div>
        </div>
        
        {% if reports %}
            <table>
                <thead>
                <tr>
                    <th>Report</th>
                    <th>Created</th>
                </tr>
                </thead>
                <tbody>
                {% for r in reports %}
                    <tr>
                        <td>
                            <a class="report-link" href="/reports/{{ r.rel_path }}?v={{ now }}" target="_blank">{{ r.name }}</a>
                        </td>
                        <td>
                            {% if r.created %}{{ r.created|date:"Y-m-d H:i:s" }}{% else %}-{% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #9ca3af; font-size: 0.9rem;">
                No HTML reports found in <code>reports/</code> yet.
                Run a scan and refresh this page.
            </p>
        {% endif %}
        
        <!-- Scan History Section -->
        {% if scan_history %}
        <div style="margin-top: 2rem; border-top: 1px solid #1f2937; padding-top: 1.5rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem;">Recent Scan History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Target</th>
                        <th>Status</th>
                        <th>Vulnerabilities</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in scan_history %}
                    <tr data-scan-id="{{ scan.job_id }}" data-scan-status="{{ scan.status }}">
                        <td><code style="font-size: 0.75rem;">{{ scan.job_id|slice:":12" }}...</code></td>
                        <td>
                            {{ scan.target|truncatechars:33 }}
                            {% if scan.status == 'running' %}
                            <div style="margin-top: 0.5rem;" class="scan-progress-container">
                                <div style="width: 100%; height: 6px; background: #1f2937; border-radius: 3px; overflow: hidden;">
                                    <div class="scan-progress-bar" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <div class="scan-progress-text" style="font-size: 0.65rem; color: #9ca3af; margin-top: 0.25rem;">Loading...</div>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="tag {% if scan.status == 'completed' %}status-completed{% elif scan.status == 'running' %}status-running{% else %}{% endif %}" style="font-size: 0.7rem;">
                                {{ scan.status }}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            {% if scan.vulnerabilities > 0 %}
                                <strong style="color: #ef4444;">{{ scan.vulnerabilities }}</strong>
                            {% else %}
                                <span style="color: #6b7280;">0</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.8rem; color: #9ca3af;">{{ scan.created_at|date:"Y-m-d H:i" }}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                                {% if scan.status == 'running' %}
                                <button onclick="stopScan('{{ scan.job_id }}')" class="btn-sm" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #f59e0b; border-radius: 0.4rem; border: none; color: white; cursor: pointer; transition: all 0.2s; min-width: 70px; font-weight: 500;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">‚èπÔ∏è Stop</button>
                                {% endif %}
                                <button onclick="viewScanDetails('{{ scan.job_id }}')" class="btn-sm btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #2563eb; border-radius: 0.4rem; border: none; color: white; cursor: pointer; transition: all 0.2s; min-width: 70px; font-weight: 500;" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">üìã Details</button>
                                {% if scan.status == 'completed' and scan.report_path %}
                                <button onclick="window.open('/reports/{{ scan.report_path }}?v=' + Date.now(), '_blank')" class="btn-sm" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #10b981; border-radius: 0.4rem; border: none; color: white; cursor: pointer; transition: all 0.2s; min-width: 70px; font-weight: 500;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">üìÑ Report</button>
                                <button onclick="exportScan('{{ scan.job_id }}', 'json')" class="btn-sm" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #059669; border-radius: 0.4rem; border: none; color: white; cursor: pointer; transition: all 0.2s; min-width: 60px; font-weight: 500;" onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#059669'">JSON</button>
                                <button onclick="exportScan('{{ scan.job_id }}', 'md')" class="btn-sm" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #7c3aed; border-radius: 0.4rem; border: none; color: white; cursor: pointer; transition: all 0.2s; min-width: 60px; font-weight: 500;" onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">MD</button>
                                {% endif %}
                                <button onclick="deleteScan('{{ scan.job_id }}')" class="btn-sm" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #dc2626; border-radius: 0.4rem; border: none; color: white; cursor: pointer; transition: all 0.2s; min-width: 40px; font-weight: 500;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </section>
</main>

<!-- Scan Details Modal -->
<div id="scanDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #0b1120; border: 1px solid #1f2937; border-radius: 0.75rem; padding: 2rem; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; font-size: 1.3rem;">Scan Details</h2>
            <button onclick="closeModal()" style="background: transparent; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        <div id="modalContent" style="color: #e5e7eb; font-size: 0.9rem;">
            <!-- Dynamic content will be inserted here -->
        </div>
        
        <!-- Terminal Log Viewer - HIDDEN FOR NOW -->
        <!--
        <div id="terminalContainer" style="display: none; margin-top: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <div style="color: #9ca3af; font-size: 0.9rem; font-weight: 600;">üíª Live Scan Output</div>
                <button onclick="toggleTerminal()" id="terminalToggleBtn" style="background: #374151; border: none; color: #9ca3af; padding: 0.4rem 0.8rem; border-radius: 0.4rem; font-size: 0.8rem; cursor: pointer;">‚ñº Hide</button>
            </div>
            <div id="terminalContent" style="background: #000; border: 2px solid #1f2937; border-radius: 0.5rem; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.75rem; color: #00ff00; max-height: 300px; overflow-y: auto; line-height: 1.4;">
                <div id="logLines">Initializing...</div>
            </div>
        </div>
        -->
    </div>
</div>

<!-- Buy Extra Scans Modal -->
<div id="buyExtraScansModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1001; align-items: center; justify-content: center;">
    <div style="background: #0b1120; border: 1px solid #1f2937; border-radius: 0.75rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; font-size: 1.3rem;">üíé Buy Extra Scans</h2>
            <button onclick="closeBuyExtraScans()" style="background: transparent; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        
        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem;">
            Your daily limit has been reached. Purchase additional scans to continue scanning this month.
        </p>
        
        <div style="display: grid; gap: 1rem;">
            <!-- 10 Scans Package -->
            <div onclick="buyExtraScans('10_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">10 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.30 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨2.99</div>
                </div>
            </div>
            
            <!-- 25 Scans Package -->
            <div onclick="buyExtraScans('25_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s; position: relative;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="position: absolute; top: -10px; right: 10px; background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 600;">BEST VALUE</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">25 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.24 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨5.99</div>
                </div>
            </div>
            
            <!-- 50 Scans Package -->
            <div onclick="buyExtraScans('50_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">50 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.20 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨9.99</div>
                </div>
            </div>
            
            <!-- 100 Scans Package -->
            <div onclick="buyExtraScans('100_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">100 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.16 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨15.99</div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; border: 1px solid rgba(59, 130, 246, 0.3);">
            <div style="font-size: 0.8rem; color: #9ca3af;">
                <strong style="color: #3b82f6;">‚ÑπÔ∏è Note:</strong> Extra scans never expire and can be used anytime.
            </div>
        </div>
    </div>
</div>

<script>
    // Version: 2024-11-30-18:10 - Detector Timeline + Auto-refresh fixes
    // Store last known scan statuses to detect changes
    let lastScanStatuses = {};
    let needsPageReload = false;
    
    // Poll scan status via AJAX and update only the scan list (no full page reload)
    async function updateScanStatuses() {
        try {
            const response = await fetch('/api/scans/status/', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            if (!response.ok) return;
            
            const scans = await response.json();
            
            // Update each scan's progress
            for (const scan of scans) {
                const scanCard = document.querySelector(`.scan-card-${scan.id}`);
                if (!scanCard) continue;
                
                // Update status badge
                const statusBadge = scanCard.querySelector(`.scan-status-${scan.id}`);
                if (statusBadge) {
                    statusBadge.textContent = scan.status;
                    statusBadge.className = `tag scan-status-${scan.id}`;
                    if (scan.status === 'running') statusBadge.classList.add('status-running');
                    else if (scan.status === 'completed') statusBadge.classList.add('status-completed');
                    else if (scan.status === 'failed') statusBadge.classList.add('status-failed');
                    else statusBadge.classList.add('status-pending');
                }
                
                // Update progress bar for running scans
                if (scan.status === 'running' || scan.status === 'pending') {
                    const progressFill = scanCard.querySelector(`.scan-progress-${scan.id}`);
                    const progressText = scanCard.querySelector(`.scan-progress-text-${scan.id}`);
                    const stepText = scanCard.querySelector(`.scan-step-${scan.id}`);
                    
                    if (progressFill) {
                        progressFill.style.width = `${scan.progress || 0}%`;
                    }
                    if (progressText) {
                        progressText.textContent = `${scan.progress || 0}%`;
                    }
                    if (stepText && scan.current_step) {
                        stepText.textContent = scan.current_step;
                    }
                }
                
                // Reload page if scan completed (to show reports)
                const lastStatus = lastScanStatuses[scan.id];
                if (lastStatus === 'running' && (scan.status === 'completed' || scan.status === 'failed')) {
                    console.log(`Scan ${scan.id} completed - reloading page...`);
                    setTimeout(() => window.location.reload(), 1000);
                }
                lastScanStatuses[scan.id] = scan.status;
            }
        } catch (error) {
            console.error('Failed to update scan statuses:', error);
        }
    }

    // Poll every 3 seconds for active progress
    setInterval(updateScanStatuses, 3000);
    
    // Update progress bars for running scans
    async function updateProgressBars() {
        const runningScans = document.querySelectorAll('tr[data-scan-status="running"]');
        
        for (const row of runningScans) {
            const jobId = row.dataset.scanId;
            const progressBar = row.querySelector('.scan-progress-bar');
            const progressText = row.querySelector('.scan-progress-text');
            
            if (!progressBar || !progressText) continue;
            
            try {
                const response = await fetch(`/api/scan/${jobId}/progress`);
                if (!response.ok) continue;
                
                const progress = await response.json();
                
                // Update progress bar
                progressBar.style.width = `${progress.progress_percentage || 0}%`;
                
                // Update text
                const urlsText = progress.total_urls > 0 
                    ? `${progress.urls_scanned || 0}/${progress.total_urls}` 
                    : 'Starting...';
                const findingsText = progress.vulnerabilities_found > 0 
                    ? ` ‚Ä¢ ${progress.vulnerabilities_found} findings` 
                    : '';
                progressText.textContent = `${progress.progress_percentage || 0}% ‚Ä¢ ${urlsText}${findingsText}`;
            } catch (error) {
                // Silently continue - scan may have just completed
            }
        }
    }
    
    // Update progress bars every 5 seconds
    setInterval(updateProgressBars, 5000);
    // Initial update
    updateProgressBars();

    async function stopScan(jobId) {
        if (!confirm('Are you sure you want to stop this scan?')) {
            return;
        }
        
        try {
            await window.api.stopScan(jobId);
            alert('Scan stopped successfully');
            window.location.reload();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    function toggleDetectorsList() {
        const list = document.getElementById('detectors-list');
        list.style.display = list.style.display === 'none' ? 'block' : 'none';
    }
    
    async function changeTier(newPlanId) {
        try {
            await window.api.changeTier(newPlanId);
            alert('Subscription plan changed successfully!');
            window.location.reload();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Intercept form submission to show tier errors
    document.querySelector('form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get target from the new simple field
        const targetInput = document.getElementById('target');
        const target = targetInput ? targetInput.value.trim() : '';
        
        if (!target) {
            alert('‚ö†Ô∏è Please enter a target domain or URL');
            return;
        }
        
        const scanType = 'web_security'; // Always web_security for now
        
        try {
            await window.api.startScan(target, scanType);
            window.location.reload();
        } catch (error) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.textContent = '‚ö†Ô∏è ' + error.message;
                errorDiv.style.display = 'block';
            } else {
                alert('Error: ' + error.message);
            }
        }
    });
    
    // Extra Scans Modal Functions
    function showBuyExtraScans() {
        document.getElementById('buyExtraScansModal').style.display = 'flex';
    }
    
    function closeBuyExtraScans() {
        document.getElementById('buyExtraScansModal').style.display = 'none';
    }
    
    async function buyExtraScans(quantity) {
        try {
            const data = await window.api.buyExtraScans(quantity);
            if (data.checkout_url) {
                window.location.href = data.checkout_url;  // Redirect to Stripe Checkout
            } else {
                alert('Extra scans added successfully!');
                window.location.reload();
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Close modal when clicking outside
    document.getElementById('buyExtraScansModal')?.addEventListener('click', function(e) {
        if (e.target.id === 'buyExtraScansModal') {
            closeBuyExtraScans();
        }
    });
    
    // Check for success/cancel messages
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('extra_scans_success') === 'true') {
        alert('‚úÖ Extra scans purchased successfully! You can now continue scanning.');
        // Remove query parameter
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    if (urlParams.get('extra_scans_cancel') === 'true') {
        alert('‚ùå Purchase cancelled. You can try again anytime.');
        // Remove query parameter
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Modal functions
    function closeModal() {
        document.getElementById('scanDetailsModal').style.display = 'none';
        
        // Stop all polling and streaming
        if (window.logEventSource) {
            window.logEventSource.close();
            window.logEventSource = null;
        }
        
        if (progressPollingInterval) {
            clearInterval(progressPollingInterval);
            progressPollingInterval = null;
        }
    }
    
    function toggleTerminal() {
        const content = document.getElementById('terminalContent');
        const btn = document.getElementById('terminalToggleBtn');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            btn.textContent = '‚ñº Hide';
        } else {
            content.style.display = 'none';
            btn.textContent = '‚ñ∂ Show';
        }
    }
    
    async function viewScanDetails(jobId) {
        try {
            const response = await fetch(`/api/scan/${jobId}/details`);
            if (!response.ok) throw new Error('Failed to fetch scan details');
            
            const scan = await response.json();
            
            // Fetch progress data if scan is running
            let progressHTML = '';
            if (scan.status === 'running') {
                try {
                    const progressResponse = await fetch(`/api/scan/${jobId}/progress`);
                    if (progressResponse.ok) {
                        const progress = await progressResponse.json();
                        const percentage = progress.progress_percentage || 0;
                        const etaText = progress.eta_seconds ? formatDuration(progress.eta_seconds) : 'calculating...';
                        
                        progressHTML = `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-size: 0.85rem; color: #9ca3af;">Scan Progress</div>
                                <div class="progress-text" style="font-size: 1rem; font-weight: 600; color: #3b82f6;">${percentage}%</div>
                            </div>
                            <div style="width: 100%; height: 8px; background: #1f2937; border-radius: 4px; overflow: hidden; margin-bottom: 0.75rem;">
                                <div class="progress-fill" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: ${percentage}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.8rem;">
                                <div>
                                    <div style="color: #6b7280;">URLs Scanned</div>
                                    <div data-urls-scanned style="color: #e5e7eb; font-weight: 600;">${progress.urls_scanned || 0} / ${progress.total_urls || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280;">Findings</div>
                                    <div data-vulns-found style="color: #ef4444; font-weight: 600;">${progress.vulnerabilities_found || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280;">ETA</div>
                                    <div style="color: #e5e7eb; font-weight: 600;">${etaText}</div>
                                </div>
                            </div>
                        </div>
                        `;
                        
                        // Start progress polling
                        startProgressPolling(jobId);
                    }
                } catch (e) {
                    console.error('Failed to fetch progress:', e);
                }
            }
            
            // Fetch findings if scan is completed
            let findingsHTML = '';
            let findingsTotal = 0; // Track total findings from API
            if (scan.status === 'completed') {
                try {
                    const findingsResponse = await fetch(`/api/scan/${jobId}/findings`);
                    if (findingsResponse.ok) {
                        const findings = await findingsResponse.json();
                        findingsTotal = findings.total; // Store total from API
                        
                        if (findings.total > 0) {
                            const severityColors = {
                                critical: '#dc2626',
                                high: '#ea580c',
                                medium: '#f59e0b',
                                low: '#10b981',
                                info: '#3b82f6'
                            };
                            
                            const severityIcons = {
                                critical: 'üî¥',
                                high: 'üü†',
                                medium: 'üü°',
                                low: 'üü¢',
                                info: 'üîµ'
                            };
                            
                            findingsHTML = `
                            <div style="border-top: 1px solid #374151; padding-top: 1rem; margin-top: 1rem;">
                                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #f3f4f6;">
                                    üîç Findings Breakdown
                                </h3>
                                
                                <!-- Severity Summary -->
                                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                    ${findings.critical.length > 0 ? `
                                    <div style="background: rgba(220, 38, 38, 0.1); border: 1px solid ${severityColors.critical}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">Critical</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.critical};">${findings.critical.length}</div>
                                    </div>
                                    ` : ''}
                                    ${findings.high.length > 0 ? `
                                    <div style="background: rgba(234, 88, 12, 0.1); border: 1px solid ${severityColors.high}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">High</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.high};">${findings.high.length}</div>
                                    </div>
                                    ` : ''}
                                    ${findings.medium.length > 0 ? `
                                    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid ${severityColors.medium}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">Medium</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.medium};">${findings.medium.length}</div>
                                    </div>
                                    ` : ''}
                                    ${findings.low.length > 0 ? `
                                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid ${severityColors.low}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">Low</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.low};">${findings.low.length}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Findings List -->
                                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #374151; border-radius: 0.5rem; background: #0f172a;">
                                    ${['critical', 'high', 'medium', 'low', 'info'].map(severity => {
                                        if (findings[severity].length === 0) return '';
                                        return `
                                        <div style="border-bottom: 1px solid #1f2937; padding: 0.75rem;">
                                            <div style="font-size: 0.8rem; font-weight: 600; color: ${severityColors[severity]}; margin-bottom: 0.5rem;">
                                                ${severityIcons[severity]} ${severity.toUpperCase()} (${findings[severity].length})
                                            </div>
                                            ${findings[severity].slice(0, 3).map(finding => `
                                                <div style="margin-left: 1.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 0.25rem;">
                                                    <div style="font-size: 0.75rem; color: #f3f4f6; font-weight: 500;">${finding.type}</div>
                                                    <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;">
                                                        <span style="color: #60a5fa;">üìç ${finding.url}</span>
                                                    </div>
                                                    <div style="font-size: 0.7rem; color: #d1d5db; margin-top: 0.25rem;">
                                                        ${finding.description}
                                                    </div>
                                                    <div style="font-size: 0.65rem; color: #6b7280; margin-top: 0.25rem;">
                                                        Detector: ${finding.detector} | Confidence: ${finding.confidence}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${findings[severity].length > 3 ? `
                                                <div style="margin-left: 1.5rem; font-size: 0.7rem; color: #6b7280; font-style: italic;">
                                                    ...and ${findings[severity].length - 3} more
                                                </div>
                                            ` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            `;
                        }
                    }
                } catch (e) {
                    console.error('Failed to fetch findings:', e);
                }
            }
            
            const modalContent = `
                ${progressHTML}
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Job ID</div>
                        <div style="font-family: monospace; font-size: 0.85rem;">${scan.job_id}</div>
                    </div>
                    <div>
                        <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Target</div>
                        <div>${scan.target}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Mode</div>
                            <div><span class="tag" style="background: #1f2937; padding: 0.25rem 0.6rem; font-size: 0.75rem;">${scan.mode}</span></div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Status</div>
                            <div><span class="tag status-${scan.status}" style="padding: 0.25rem 0.6rem; font-size: 0.75rem;">${scan.status}</span></div>
                        </div>
                    </div>
                    <div>
                        <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Vulnerabilities Found</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${(findingsTotal || scan.vulnerabilities_found) > 0 ? '#ef4444' : '#22c55e'};">
                            ${findingsTotal || scan.vulnerabilities_found || 0}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Started</div>
                            <div style="font-size: 0.85rem;">${scan.started_at ? new Date(scan.started_at).toLocaleString() : 'N/A'}</div>
                        </div>
                        ${scan.completed_at ? `
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Completed</div>
                            <div style="font-size: 0.85rem;">${new Date(scan.completed_at).toLocaleString()}</div>
                        </div>
                        ` : ''}
                    </div>
                    ${scan.report_path ? `
                    <div>
                        <a href="${scan.report_path}?v=${Date.now()}" target="_blank" class="btn-primary" style="display: inline-block; padding: 0.5rem 1rem; text-decoration: none; border-radius: 0.4rem;">
                            üìÑ View Full Report
                        </a>
                    </div>
                    ` : ''}
                    
                    ${findingsHTML}
                </div>
                
                <!-- Detector Timeline Section -->
                <div id="detectorTimelineSection" style="border-top: 1px solid #374151; padding-top: 1rem; margin-top: 1rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #f3f4f6;">
                        ‚è±Ô∏è Detector Timeline
                    </h3>
                    <div id="detectorTimelineContent" style="color: #9ca3af; font-size: 0.85rem;">
                        Loading timeline...
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('scanDetailsModal').style.display = 'flex';
            
            // Load detector timeline after DOM has updated
            setTimeout(() => {
                loadDetectorTimeline(jobId);
            }, 0);
            
            // Terminal container is commented out in HTML, so skip log streaming
            // if (scan.log_path) {
            //     document.getElementById('terminalContainer').style.display = 'block';
            //     document.getElementById('terminalContent').style.display = 'block';
            //     startLogStreaming(jobId);
            // }
        } catch (error) {
            alert('Error loading scan details: ' + error.message);
        }
    }
    
    // Load and display detector timeline
    async function loadDetectorTimeline(jobId) {
        const timelineContent = document.getElementById('detectorTimelineContent');
        
        if (!timelineContent) {
            console.warn('Timeline content element not found, skipping...');
            return;
        }
        
        try {
            console.log(`Loading detector timeline for job ${jobId}...`);
            const response = await fetch(`/api/scan/${jobId}/detector-timeline`);
            if (!response.ok) {
                console.error(`Timeline fetch failed with status ${response.status}`);
                throw new Error('Failed to fetch timeline');
            }
            
            const data = await response.json();
            console.log(`Timeline data received:`, data);
            const timeline = data.timeline || [];
            
            if (timeline.length === 0) {
                console.warn('Timeline is empty!');
                // Show a helpful message - timeline might be empty if scan completed before logging details
                timelineContent.innerHTML = '<div style="color: #6b7280; font-style: italic;">No detailed detector timeline available. This can happen if the scan completed very quickly or logs are not accessible. Check "Findings Breakdown" above for detected vulnerabilities.</div>';
                return;
            }
            
            console.log(`Rendering ${timeline.length} timeline events...`);
            
            // Build timeline HTML
            let html = '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #374151; border-radius: 0.5rem; background: #0f172a; padding: 0.75rem;">';
            
            // Show chronological list
            timeline.forEach((event, idx) => {
                const timestamp = new Date(event.timestamp);
                const timeStr = timestamp.toLocaleTimeString('bg-BG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                // Status icon and color based on event type
                let icon = 'üîç';
                let color = '#3b82f6';
                let statusText = event.detector;
                let badgeHTML = '';
                
                if (event.type === 'finding') {
                    icon = '‚úîÔ∏è';
                    const severityColors = {
                        critical: '#dc2626',
                        high: '#ea580c',
                        medium: '#f59e0b',
                        low: '#10b981',
                        info: '#3b82f6'
                    };
                    color = severityColors[event.severity] || '#22c55e';
                    badgeHTML = `<span style="background: ${color}; color: white; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.65rem; margin-left: 0.5rem; text-transform: uppercase;">${event.severity}</span>`;
                    statusText = 'Found: ' + event.detector;
                } else if (event.type === 'phase') {
                    icon = '‚öôÔ∏è';
                    color = '#8b5cf6';
                    statusText = 'Phase: ' + event.detector;
                } else if (event.type === 'scan_event') {
                    if (event.status === 'started') {
                        icon = '‚ñ∂Ô∏è';
                        color = '#22c55e';
                    } else {
                        icon = '‚úÖ';
                        color = '#10b981';
                    }
                }
                
                html += `
                <div style="display: flex; gap: 0.75rem; padding: 0.5rem; margin-bottom: 0.5rem; background: rgba(0, 0, 0, 0.3); border-left: 3px solid ${color}; border-radius: 0.25rem;">
                    <div style="flex-shrink: 0; width: 70px; color: #9ca3af; font-size: 0.7rem; font-family: monospace;">
                        ${timeStr}
                    </div>
                    <div style="flex-shrink: 0; font-size: 1rem;">
                        ${icon}
                    </div>
                    <div style="flex: 1;">
                        <div style="color: #e5e7eb; font-size: 0.8rem; font-weight: 500;">
                            ${statusText}${badgeHTML}
                        </div>
                    </div>
                </div>
                `;
            });
            
            html += '</div>';
            
            // Add summary stats
            const findingsCount = timeline.filter(e => e.type === 'finding').length;
            const phasesCount = timeline.filter(e => e.type === 'phase').length;
            
            html += `
            <div style="display: flex; gap: 1rem; margin-top: 0.75rem; font-size: 0.75rem;">
                ${findingsCount > 0 ? `<div style="color: #9ca3af;"><span style="color: #22c55e; font-weight: 600;">${findingsCount}</span> findings</div>` : ''}
                ${phasesCount > 0 ? `<div style="color: #9ca3af;"><span style="color: #8b5cf6; font-weight: 600;">${phasesCount}</span> phases</div>` : ''}
                <div style="color: #9ca3af;">
                    <span style="color: #e5e7eb; font-weight: 600;">${timeline.length}</span> total events
                </div>
            </div>
            `;
            
            timelineContent.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading detector timeline:', error);
            timelineContent.innerHTML = '<div style="color: #ef4444;">Failed to load detector timeline</div>';
        }
    }
    
    // Helper function to format duration in human-readable format
    function formatDuration(seconds) {
        if (seconds < 60) return `${seconds}s`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${mins}m`;
    }
    
    // Update progress elements in modal without reloading entire modal
    function updateProgressInModal(progress) {
        // Update progress bar
        const progressBar = document.querySelector('#scanDetailsModal .progress-fill');
        if (progressBar && progress.progress_percentage !== undefined) {
            progressBar.style.width = `${progress.progress_percentage}%`;
        }
        
        // Update progress text
        const progressText = document.querySelector('#scanDetailsModal .progress-text');
        if (progressText) {
            progressText.textContent = `${progress.progress_percentage || 0}%`;
        }
        
        // Update URLs scanned
        const urlsText = document.querySelector('#scanDetailsModal [data-urls-scanned]');
        if (urlsText && progress.urls_scanned !== undefined) {
            urlsText.textContent = `${progress.urls_scanned} / ${progress.total_urls || '?'}`;
        }
        
        // Update vulnerabilities found
        const vulnsText = document.querySelector('#scanDetailsModal [data-vulns-found]');
        if (vulnsText && progress.vulnerabilities_found !== undefined) {
            vulnsText.textContent = progress.vulnerabilities_found;
        }
    }
    
    // Poll progress updates
    let progressPollingInterval = null;
    function startProgressPolling(jobId) {
        // Clear existing interval
        if (progressPollingInterval) {
            clearInterval(progressPollingInterval);
        }
        
        progressPollingInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/scan/${jobId}/progress`);
                if (!response.ok) {
                    clearInterval(progressPollingInterval);
                    progressPollingInterval = null;
                    return;
                }
                
                const progress = await response.json();
                
                // Update progress bar and stats if modal is still open (without full reload)
                const modal = document.getElementById('scanDetailsModal');
                if (modal && modal.style.display === 'flex') {
                    // Update only progress elements, not the whole modal
                    updateProgressInModal(progress);
                } else {
                    // Stop polling if modal is closed
                    clearInterval(progressPollingInterval);
                    progressPollingInterval = null;
                }
            } catch (error) {
                console.error('Progress polling error:', error);
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
        }, 5000); // Poll every 5 seconds
    }
    
    function startLogStreaming(jobId) {
        const logContainer = document.getElementById('logLines');
        logContainer.innerHTML = '<span style="color: #fbbf24;">[Connecting to scan output...]</span>';
        
        // Close existing connection if any
        if (window.logEventSource) {
            window.logEventSource.close();
        }
        
        // Get token from cookie for authentication
        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        };
        
        const token = getCookie('access_token');
        
        if (!token) {
            logContainer.innerHTML = '<span style="color: #ef4444;">[Authentication error: No token found. Please refresh the page.]</span>';
            return;
        }
        
        // Create EventSource for Server-Sent Events with token in URL
        const url = `/api/scan/${jobId}/stream-log?token=${encodeURIComponent(token)}`;
        const eventSource = new EventSource(url);
        window.logEventSource = eventSource;
        
        let lineCount = 0;
        const maxLines = 500; // Limit to last 500 lines
        
        eventSource.onmessage = function(event) {
            const line = event.data;
            
            // Create line element
            const lineDiv = document.createElement('div');
            lineDiv.textContent = line;
            
            // Color coding based on content
            if (line.includes('[ERROR]') || line.includes('Error') || line.includes('FAIL')) {
                lineDiv.style.color = '#ef4444';
            } else if (line.includes('[SUCCESS]') || line.includes('Found') || line.includes('Detected')) {
                lineDiv.style.color = '#22c55e';
            } else if (line.includes('[WARN]') || line.includes('Warning')) {
                lineDiv.style.color = '#fbbf24';
            } else if (line.includes('[INFO]')) {
                lineDiv.style.color = '#3b82f6';
            }
            
            if (lineCount === 0) {
                // First line, replace "Connecting" message
                logContainer.innerHTML = '';
            }
            
            logContainer.appendChild(lineDiv);
            lineCount++;
            
            // Remove old lines if too many
            if (lineCount > maxLines) {
                logContainer.removeChild(logContainer.firstChild);
                lineCount--;
            }
            
            // Auto-scroll to bottom
            const terminal = document.getElementById('terminalContent');
            terminal.scrollTop = terminal.scrollHeight;
        };
        
        eventSource.onerror = function(error) {
            // Suppress normal disconnection errors (scan completed)
            if (eventSource.readyState === EventSource.CLOSED) {
                // Connection closed permanently - scan likely completed
                if (lineCount > 0) {
                    // Only show message if we received logs
                    logContainer.innerHTML += '<div style="color: #10b981;">[‚úì Scan completed - log stream closed]</div>';
                }
            }
            // EventSource will automatically retry for temporary errors
        };
        
        eventSource.onopen = function() {
            // Connection opened - no console log needed
        };
    }
    
    async function exportScan(jobId, format) {
        try {
            const endpoint = format === 'json' ? 
                `/api/scan/${jobId}/export/json` : 
                `/api/scan/${jobId}/export/markdown`;
            
            window.open(endpoint, '_blank');
        } catch (error) {
            alert('Error exporting scan: ' + error.message);
        }
    }
    
    async function deleteScan(jobId) {
        if (!confirm('‚ö†Ô∏è Are you sure you want to delete this scan? This cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/scan/${jobId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.innerHTML = '‚úÖ Scan deleted successfully';
                successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 9999; box-shadow: 0 10px 25px rgba(34, 197, 94, 0.5);';
                document.body.appendChild(successMsg);
                
                // Reload after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                const data = await response.json();
                alert('‚ùå Error: ' + (data.detail || 'Failed to delete scan'));
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }
    
    async function validateScope() {
        const scopeFile = document.getElementById('scope_file').value;
        if (!scopeFile) {
            alert('‚ö†Ô∏è Please enter a scope file path');
            return;
        }
        
        try {
            const response = await fetch(window.API_URLS.validateScope, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': window.getCsrfToken()},
                body: JSON.stringify({scope_file: scopeFile})
            });
            
            if (response.ok) {
                const data = await response.json();
                document.getElementById('in-scope-count').textContent = data.in_scope_count;
                document.getElementById('out-scope-count').textContent = data.out_of_scope_count;
                document.getElementById('scope-validation').style.display = 'block';
                
                if (data.out_of_scope_count > 0) {
                    const warning = document.createElement('div');
                    warning.style.cssText = 'margin-top: 0.5rem; color: #fbbf24; font-size: 0.75rem;';
                    warning.innerHTML = '‚ö†Ô∏è Out-of-scope domains will be filtered out during scan';
                    document.getElementById('scope-validation').appendChild(warning);
                }
            } else {
                const data = await response.json();
                alert('‚ùå Error: ' + (data.detail || 'Failed to validate scope'));
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }
    
    // Open billing portal
    async function openBillingPortal() {
        try {
            const data = await window.api.getBillingPortal();
            if (data.portal_url) {
                window.location.href = data.portal_url;
            } else {
                alert(data.message || 'Billing portal not available');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Close modal when clicking outside
    document.getElementById('scanDetailsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // WebSocket support for real-time scan progress
    const activeWebSockets = new Map();
    
    function connectToScan(scanId) {
        // Skip if already connected
        if (activeWebSockets.has(scanId)) {
            return;
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/scan/${scanId}/`;
        
        console.log(`Connecting to WebSocket: ${wsUrl}`);
        
        const ws = new WebSocket(wsUrl);
        activeWebSockets.set(scanId, ws);
        
        ws.onopen = () => {
            console.log(`WebSocket connected for scan ${scanId}`);
        };
        
        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                console.log('WebSocket message:', message);
                
                if (message.type === 'scan_update') {
                    updateScanProgress(scanId, message.data);
                } else if (message.type === 'scan_complete') {
                    handleScanComplete(scanId, message.data);
                } else if (message.type === 'scan_error') {
                    handleScanError(scanId, message.data);
                }
            } catch (error) {
                console.error('WebSocket message error:', error);
            }
        };
        
        ws.onerror = (error) => {
            console.error(`WebSocket error for scan ${scanId}:`, error);
        };
        
        ws.onclose = () => {
            console.log(`WebSocket closed for scan ${scanId}`);
            activeWebSockets.delete(scanId);
        };
    }
    
    function updateScanProgress(scanId, data) {
        // Update progress bar in scan row
        const row = document.querySelector(`tr[data-scan-id="${scanId}"]`);
        if (!row) return;
        
        const progressBar = row.querySelector('.scan-progress-bar');
        const progressText = row.querySelector('.scan-progress-text');
        
        if (progressBar && data.progress !== undefined) {
            progressBar.style.width = `${data.progress}%`;
        }
        
        if (progressText && data.current_step) {
            progressText.textContent = `${data.progress || 0}% ‚Ä¢ ${data.current_step}`;
        }
        
        // Update modal if open
        if (document.getElementById('scanDetailsModal').style.display === 'flex') {
            updateProgressInModal(data);
        }
    }
    
    function handleScanComplete(scanId, data) {
        console.log(`Scan ${scanId} completed:`, data);
        
        // Show notification
        const notification = document.createElement('div');
        notification.innerHTML = `‚úÖ Scan completed! Found ${data.vulnerabilities_found || 0} vulnerabilities.`;
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 9999; box-shadow: 0 10px 25px rgba(34, 197, 94, 0.5);';
        document.body.appendChild(notification);
        
        // Close WebSocket
        const ws = activeWebSockets.get(scanId);
        if (ws) {
            ws.close();
            activeWebSockets.delete(scanId);
        }
        
        // Reload page after 2 seconds to show updated results
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    }
    
    function handleScanError(scanId, data) {
        console.error(`Scan ${scanId} error:`, data);
        
        // Show error notification
        const notification = document.createElement('div');
        notification.innerHTML = `‚ùå Scan failed: ${data.error || 'Unknown error'}`;
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 9999; box-shadow: 0 10px 25px rgba(239, 68, 68, 0.5);';
        document.body.appendChild(notification);
        
        // Close WebSocket
        const ws = activeWebSockets.get(scanId);
        if (ws) {
            ws.close();
            activeWebSockets.delete(scanId);
        }
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 5000);
    }
    
    // Connect to all running scans on page load
    document.addEventListener('DOMContentLoaded', () => {
        const runningScans = document.querySelectorAll('tr[data-scan-status="running"]');
        runningScans.forEach(row => {
            const scanId = row.dataset.scanId;
            if (scanId) {
                connectToScan(scanId);
            }
        });
    });
    
    // Cleanup WebSockets on page unload
    window.addEventListener('beforeunload', () => {
        activeWebSockets.forEach(ws => ws.close());
        activeWebSockets.clear();
    });
</script>
</body>
</html>
