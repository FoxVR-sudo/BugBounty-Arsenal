<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>BugBounty Arsenal UI</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #050816;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
        }
        header {
            padding: 1.5rem 2rem;
            background: linear-gradient(90deg, #0f172a, #111827);
            border-bottom: 1px solid #1f2937;
        }
        h1 {
            margin: 0;
            font-size: 1.6rem;
        }
        main {
            display: flex;
            gap: 2rem;
            padding: 2rem;
        }
        .card {
            background: #0b1120;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
        }
        .card h2 {
            margin-top: 0;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        form label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            color: #9ca3af;
        }
        form input[type="text"],
        form select {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            margin-bottom: 0.75rem;
        }
        form input[type="text"]:focus,
        form select:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
        }
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1.2rem;
            border-radius: 0.5rem;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #111827;
        }
        th {
            text-align: left;
            color: #9ca3af;
            font-weight: 500;
        }
        tr:hover td {
            background: rgba(15, 23, 42, 0.7);
        }
        a.report-link {
            color: #38bdf8;
            text-decoration: none;
        }
        a.report-link:hover {
            text-decoration: underline;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 0.1rem 0.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
        }
        .status-running {
            background: rgba(34, 197, 94, 0.15);
            color: #86efac;
        }
        .status-completed {
            background: rgba(100, 116, 139, 0.15);
            color: #94a3b8;
        }
        .scan-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            border-left: 3px solid #22c55e;
        }
        .scan-item.completed {
            border-left-color: #64748b;
        }
        .btn-log {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 0.3rem;
            background: rgba(56, 189, 248, 0.15);
            color: #38bdf8;
            text-decoration: none;
            margin-left: 0.5rem;
        }
        .btn-log:hover {
            background: rgba(56, 189, 248, 0.25);
        }
        .btn-stop {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 0.3rem;
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            text-decoration: none;
            margin-left: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .btn-stop:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        @media (max-width: 900px) {
            main {
                flex-direction: column;
            }
        }
        .status-bar {
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .progress-container {
            margin-top: 0.5rem;
            width: 100%;
            background: #020617;
            border-radius: 999px;
            border: 1px solid #1f2937;
            overflow: hidden;
            height: 8px;
        }
        .progress-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.2s ease-out;
        }
        .dot-spinner {
            display: inline-block;
            width: 32px;
            text-align: center;
        }
        .dot-spinner span {
            display: inline-block;
            width: 4px;
            height: 4px;
            margin: 0 1px;
            border-radius: 999px;
            background: #22c55e;
            opacity: 0.3;
            animation: pulse 1.2s infinite ease-in-out;
        }
        .dot-spinner span:nth-child(2) { animation-delay: 0.2s; }
        .dot-spinner span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-3px); }
        }
        
        @keyframes progress-slide {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }
        
        .progress-bar-animation {
            animation: progress-slide 2s linear infinite;
        }
    </style>
</head>
<body>
<header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>BugBounty Arsenal v2.0 ‚Äì UI</h1>
            <div style="font-size: 0.85rem; color: #9ca3af; margin-top: 0.25rem;">
                Fast async scanner ‚Ä¢ recon + standard mode ‚Ä¢ reports overview
            </div>
        </div>
        <div style="text-align: right;">
            <span class="tag" style="background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; padding: 0.3rem 0.8rem; font-size: 0.85rem; margin-bottom: 0.25rem; display: inline-block;">
                {{ tier_info.name }} PLAN
            </span>
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.5rem;">
                {{ tier_info.concurrent_scans }} scans ‚Ä¢ {{ tier_info.max_urls }} URLs ‚Ä¢ {{ tier_info.detectors }}
            </div>
            
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-bottom: 0.5rem;">
                {% if is_superuser %}
                <!-- Admin Panel Button (Superuser Only) -->
                <button onclick="window.location.href='/admin'" 
                        style="padding: 0.4rem 0.8rem; font-size: 0.75rem; border-radius: 0.4rem; border: 1px solid #dc2626; background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; cursor: pointer; font-weight: 600;">
                    üõ°Ô∏è Admin Panel
                </button>
                {% endif %}
                
                {% if tier != 'free' %}
                <!-- Manage Subscription Button for Paid Users -->
                <button onclick="window.location.href='/api/billing/portal'" 
                        style="padding: 0.4rem 0.8rem; font-size: 0.75rem; border-radius: 0.4rem; border: 1px solid #7c3aed; background: transparent; color: #a855f7; cursor: pointer;">
                    ‚öôÔ∏è Manage Subscription
                </button>
                {% else %}
                <!-- Upgrade Button for Free Users -->
                <button onclick="window.location.href='/#pricing'" 
                        style="padding: 0.4rem 0.8rem; font-size: 0.75rem; border-radius: 0.4rem; border: 1px solid #22c55e; background: #22c55e; color: white; cursor: pointer;">
                    ‚¨ÜÔ∏è Upgrade Plan
                </button>
                {% endif %}
            </div>
            
            <!-- Tier Switcher (for testing only) -->
            <div style="display: flex; gap: 0.25rem; justify-content: flex-end;">
                <button onclick="changeTier('free')" style="padding: 0.15rem 0.4rem; font-size: 0.65rem; border-radius: 0.3rem; border: 1px solid #374151; background: {% if tier == 'free' %}#22c55e{% else %}#020617{% endif %}; color: white; cursor: pointer;">FREE</button>
                <button onclick="changeTier('pro')" style="padding: 0.15rem 0.4rem; font-size: 0.65rem; border-radius: 0.3rem; border: 1px solid #374151; background: {% if tier == 'pro' %}#22c55e{% else %}#020617{% endif %}; color: white; cursor: pointer;">PRO</button>
                <button onclick="changeTier('enterprise')" style="padding: 0.15rem 0.4rem; font-size: 0.65rem; border-radius: 0.3rem; border: 1px solid #374151; background: {% if tier == 'enterprise' %}#22c55e{% else %}#020617{% endif %}; color: white; cursor: pointer;">ENT</button>
            </div>
        </div>
    </div>
</header>

<main>
    <section class="card" style="flex: 0 0 320px;">
        <h2>Start New Scan</h2>
        
        <!-- Scan Usage Counter -->
        {% if scan_stats and tier != 'enterprise' %}
        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15)); border: 1px solid rgba(34, 197, 94, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <div style="font-size: 0.9rem; font-weight: 600; color: #22c55e;">Daily Scans</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #22c55e;">
                    {{ scan_stats.daily_used }}/{{ scan_stats.daily_limit }}
                </div>
            </div>
            
            <!-- Progress bar -->
            <div style="background: rgba(15, 23, 42, 0.5); height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #22c55e, #16a34a); height: 100%; width: {{ (scan_stats.daily_used / scan_stats.daily_limit * 100) if scan_stats.daily_limit > 0 else 0 }}%; transition: width 0.3s;"></div>
            </div>
            
            {% if scan_stats.extra_scans_available > 0 %}
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(34, 197, 94, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.8rem; color: #9ca3af;">Extra Scans</div>
                    <div style="font-size: 1rem; font-weight: 600; color: #a855f7;">
                        {{ scan_stats.extra_scans_available }} available
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if scan_stats.daily_used >= scan_stats.daily_limit %}
            <div style="margin-top: 0.75rem;">
                <button onclick="showBuyExtraScans()" style="width: 100%; padding: 0.6rem; font-size: 0.85rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);">
                    üíé Buy Extra Scans
                </button>
            </div>
            {% endif %}
        </div>
        {% elif tier == 'enterprise' %}
        <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(124, 58, 237, 0.15)); border: 1px solid rgba(168, 85, 247, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 0.75rem; text-align: center;">
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ôæÔ∏è</div>
            <div style="font-size: 0.9rem; font-weight: 600; color: #a855f7;">Unlimited Scans</div>
            <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">ENTERPRISE Plan</div>
        </div>
        {% endif %}
        
        <!-- Tier Limits Notice -->
        <div style="background: rgba(168, 85, 247, 0.1); border-left: 3px solid #a855f7; padding: 0.75rem; margin-bottom: 1rem; border-radius: 0.5rem;">
            <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem;">{{ tier_info.name }} Limits:</div>
            <div style="font-size: 0.75rem; color: #9ca3af;">
                ‚Ä¢ Max {{ tier_limits.max_concurrent_scans }} concurrent scan(s)<br>
                ‚Ä¢ Up to {{ tier_info.max_urls }} URLs per scan<br>
                ‚Ä¢ Recon pipeline: {{ tier_info.recon_pipeline }}<br>
                ‚Ä¢ Nuclei CVE scans: {{ tier_info.nuclei }}
            </div>
        </div>
        
        <form method="post" action="/scan">
            <label for="mode">Mode</label>
            <select id="mode" name="mode" {% if not tier_limits.enable_recon_pipeline %}disabled{% endif %}>
                <option value="recon" {% if tier_limits.enable_recon_pipeline %}selected{% endif %}>Recon (domain pipeline)</option>
                <option value="standard" {% if not tier_limits.enable_recon_pipeline %}selected{% endif %}>Standard (scope file)</option>
            </select>
            {% if not tier_limits.enable_recon_pipeline %}
            <div style="font-size: 0.7rem; color: #ef4444; margin-top: -0.5rem; margin-bottom: 0.5rem;">
                ‚ö†Ô∏è Recon mode requires PRO or ENTERPRISE tier
            </div>
            {% endif %}

            <label for="recon_domain">Domain (for recon)</label>
            <input type="text" id="recon_domain" name="recon_domain" placeholder="example.com" />

            <label for="scope_file">Scope file (for standard) {% if tier not in ['pro', 'enterprise'] %}<span style="color: #a855f7; font-size: 0.75rem;">üîí PRO/ENTERPRISE only</span>{% endif %}</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-start; margin-bottom: 1rem;">
                <input type="text" id="scope_file" name="scope_file" value="targets.csv" {% if tier not in ['pro', 'enterprise'] %}disabled{% endif %} style="flex: 1; margin-bottom: 0;" />
                {% if tier in ['pro', 'enterprise'] %}
                <button type="button" onclick="validateScope()" class="btn-log" style="padding: 0.5rem 0.8rem; white-space: nowrap;">‚úì Validate</button>
                {% endif %}
            </div>
            {% if tier not in ['pro', 'enterprise'] %}
            <div style="font-size: 0.7rem; color: #ef4444; margin-top: -0.8rem; margin-bottom: 0.8rem;">
                ‚ö†Ô∏è Scope file scanning requires PRO or ENTERPRISE tier
            </div>
            {% endif %}
            <div id="scope-validation" style="display: none; background: rgba(34, 197, 94, 0.15); border-left: 3px solid #22c55e; padding: 0.75rem; margin-bottom: 1rem; border-radius: 0.5rem; font-size: 0.8rem;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">üìä Scope Analysis:</div>
                <div style="color: #9ca3af;">
                    ‚Ä¢ <span style="color: #22c55e;"><span id="in-scope-count">0</span> in-scope</span> domains<br>
                    ‚Ä¢ <span style="color: #ef4444;"><span id="out-scope-count">0</span> out-of-scope</span> domains
                </div>
            </div>

            <label for="scan_intensity">Scan intensity (standard)</label>
            <select id="scan_intensity" name="scan_intensity" {% if tier not in ['pro', 'enterprise'] %}disabled{% endif %}>
                <option value="safe">safe</option>
                <option value="normal" selected>normal</option>
                <option value="brute">brute</option>
            </select>

            <button type="submit" class="btn-primary" id="start-scan-btn">Start Scan</button>
        </form>
        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.75rem;">
            The scan runs in the background with the same
            <code>main.py</code> logic you use from the terminal.
        </p>

        <div style="margin-top: 1.5rem;">
            <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Active Scans</h3>
            
            <!-- Error message placeholder -->
            <div id="error-message" style="display: none; background: rgba(239, 68, 68, 0.15); border-left: 3px solid #ef4444; padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 0.5rem; color: #fca5a5; font-size: 0.8rem;"></div>
            
            <div id="active-scans-list">
                {% if active_scans %}
                    {% for job_id, scan in active_scans.items() %}
                    <div class="scan-item {% if scan.status == 'completed' %}completed{% endif %}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>{{ scan.label }}</strong>
                                <span class="tag {% if scan.status == 'running' %}status-running{% else %}status-completed{% endif %}">
                                    {{ scan.status }}
                                </span>
                            </div>
                            <div>
                                <a href="/scan-log/{{ job_id }}" target="_blank" class="btn-log">view log</a>
                                {% if scan.status == 'running' %}
                                <button onclick="stopScan('{{ job_id }}')" class="btn-stop">stop</button>
                                {% endif %}
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem;">
                            Started: {{ scan.started.strftime('%H:%M:%S') }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #6b7280; font-size: 0.8rem;">No active scans.</p>
                {% endif %}
            </div>
        </div>
    </section>

    <section class="card" style="flex: 1 1 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Available Reports</h2>
            <button onclick="toggleDetectorsList()" class="btn-log" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                View Enabled Detectors ({{ tier_info.detectors }})
            </button>
        </div>
        
        <!-- Collapsible Detectors List -->
        <div id="detectors-list" style="display: none; background: rgba(15, 23, 42, 0.7); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; max-height: 200px; overflow-y: auto;">
            <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: #38bdf8;">Active Detectors for {{ tier_info.name }} Plan:</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.75rem; color: #9ca3af;">
                {% for detector in tier_limits.allowed_detectors %}
                <div>‚úì {{ detector.replace('_', ' ').title() }}</div>
                {% endfor %}
            </div>
        </div>
        
        {% if reports %}
            <table>
                <thead>
                <tr>
                    <th>Report</th>
                    <th>Created</th>
                </tr>
                </thead>
                <tbody>
                {% for r in reports %}
                    <tr>
                        <td>
                            <a class="report-link" href="/reports/{{ r.rel_path }}?v={{ now }}" target="_blank">{{ r.name }}</a>
                        </td>
                        <td>
                            {% if r.created %}{{ r.created.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}-{% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #9ca3af; font-size: 0.9rem;">
                No HTML reports found in <code>reports/</code> yet.
                Run a scan and refresh this page.
            </p>
        {% endif %}
        
        <!-- Scan History Section -->
        {% if scan_history %}
        <div style="margin-top: 2rem; border-top: 1px solid #1f2937; padding-top: 1.5rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem;">Recent Scan History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Target</th>
                        <th>Status</th>
                        <th>Vulnerabilities</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in scan_history %}
                    <tr data-scan-id="{{ scan.job_id }}" data-scan-status="{{ scan.status }}">
                        <td><code style="font-size: 0.75rem;">{{ scan.job_id[:12] }}...</code></td>
                        <td>
                            {{ scan.target[:30] }}
                            {% if scan.status == 'running' %}
                            <div style="margin-top: 0.5rem;" class="scan-progress-container">
                                <div style="width: 100%; height: 6px; background: #1f2937; border-radius: 3px; overflow: hidden;">
                                    <div class="scan-progress-bar" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <div class="scan-progress-text" style="font-size: 0.65rem; color: #9ca3af; margin-top: 0.25rem;">Loading...</div>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="tag {% if scan.status == 'completed' %}status-completed{% elif scan.status == 'running' %}status-running{% else %}{% endif %}" style="font-size: 0.7rem;">
                                {{ scan.status }}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            {% if scan.vulnerabilities > 0 %}
                                <strong style="color: #ef4444;">{{ scan.vulnerabilities }}</strong>
                            {% else %}
                                <span style="color: #6b7280;">0</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.8rem; color: #9ca3af;">{{ scan.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                {% if scan.status == 'running' %}
                                <button onclick="stopScan('{{ scan.job_id }}')" class="btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #f59e0b; border-radius: 0.3rem; border: none; color: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">‚èπÔ∏è Stop</button>
                                {% endif %}
                                <button onclick="viewScanDetails('{{ scan.job_id }}')" class="btn-sm btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #2563eb; border-radius: 0.3rem; border: none; color: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">üìã Details</button>
                                {% if scan.status == 'completed' and scan.report_path %}
                                <button onclick="window.open('/reports/{{ scan.report_path }}?v=' + Date.now(), '_blank')" class="btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #10b981; border-radius: 0.3rem; border: none; color: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">üìÑ Report</button>
                                <button onclick="exportScan('{{ scan.job_id }}', 'json')" class="btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #059669; border-radius: 0.3rem; border: none; color: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#059669'">JSON</button>
                                <button onclick="exportScan('{{ scan.job_id }}', 'md')" class="btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #7c3aed; border-radius: 0.3rem; border: none; color: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">MD</button>
                                {% endif %}
                                <button onclick="deleteScan('{{ scan.job_id }}')" class="btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #dc2626; border-radius: 0.3rem; border: none; color: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </section>
</main>

<!-- Scan Details Modal -->
<div id="scanDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #0b1120; border: 1px solid #1f2937; border-radius: 0.75rem; padding: 2rem; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; font-size: 1.3rem;">Scan Details</h2>
            <button onclick="closeModal()" style="background: transparent; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        <div id="modalContent" style="color: #e5e7eb; font-size: 0.9rem;">
            <!-- Dynamic content will be inserted here -->
        </div>
        
        <!-- Terminal Log Viewer -->
        <div id="terminalContainer" style="display: none; margin-top: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <div style="color: #9ca3af; font-size: 0.9rem; font-weight: 600;">üíª Live Scan Output</div>
                <button onclick="toggleTerminal()" id="terminalToggleBtn" style="background: #374151; border: none; color: #9ca3af; padding: 0.4rem 0.8rem; border-radius: 0.4rem; font-size: 0.8rem; cursor: pointer;">‚ñº Hide</button>
            </div>
            <div id="terminalContent" style="background: #000; border: 2px solid #1f2937; border-radius: 0.5rem; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.75rem; color: #00ff00; max-height: 300px; overflow-y: auto; line-height: 1.4;">
                <div id="logLines">Initializing...</div>
            </div>
        </div>
    </div>
</div>

<!-- Buy Extra Scans Modal -->
<div id="buyExtraScansModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1001; align-items: center; justify-content: center;">
    <div style="background: #0b1120; border: 1px solid #1f2937; border-radius: 0.75rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; font-size: 1.3rem;">üíé Buy Extra Scans</h2>
            <button onclick="closeBuyExtraScans()" style="background: transparent; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        
        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 1.5rem;">
            Your daily limit has been reached. Purchase additional scans to continue scanning this month.
        </p>
        
        <div style="display: grid; gap: 1rem;">
            <!-- 10 Scans Package -->
            <div onclick="buyExtraScans('10_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">10 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.30 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨2.99</div>
                </div>
            </div>
            
            <!-- 25 Scans Package -->
            <div onclick="buyExtraScans('25_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s; position: relative;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="position: absolute; top: -10px; right: 10px; background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 600;">BEST VALUE</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">25 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.24 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨5.99</div>
                </div>
            </div>
            
            <!-- 50 Scans Package -->
            <div onclick="buyExtraScans('50_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">50 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.20 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨9.99</div>
                </div>
            </div>
            
            <!-- 100 Scans Package -->
            <div onclick="buyExtraScans('100_scans')" style="border: 2px solid #374151; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='rgba(34, 197, 94, 0.05)'" onmouseout="this.style.borderColor='#374151'; this.style.background='transparent'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #e5e7eb; margin-bottom: 0.25rem;">100 Extra Scans</div>
                        <div style="font-size: 0.8rem; color: #9ca3af;">‚Ç¨0.16 per scan</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">‚Ç¨15.99</div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; border: 1px solid rgba(59, 130, 246, 0.3);">
            <div style="font-size: 0.8rem; color: #9ca3af;">
                <strong style="color: #3b82f6;">‚ÑπÔ∏è Note:</strong> Extra scans never expire and can be used anytime.
            </div>
        </div>
    </div>
</div>

<script>
    // Store last known scan statuses to detect changes
    let lastScanStatuses = {};
    
    // Poll scan status via AJAX and update only the scan list (no full page reload)
    async function updateScanStatuses() {
        try {
            const response = await fetch('/scan-status');
            if (!response.ok) return;
            
            const data = await response.json();
            
            // Check if any scan status changed
            let statusChanged = false;
            if (data.scans) {
                for (const scan of data.scans) {
                    const lastStatus = lastScanStatuses[scan.job_id];
                    if (lastStatus && lastStatus !== scan.status) {
                        statusChanged = true;
                        console.log(`Scan ${scan.job_id} status changed: ${lastStatus} ‚Üí ${scan.status}`);
                    }
                    lastScanStatuses[scan.job_id] = scan.status;
                }
                
                // Reload page if any status changed
                if (statusChanged) {
                    window.location.reload();
                }
            }
        } catch (error) {
            console.error('Failed to update scan statuses:', error);
        }
    }

    // Poll every 10 seconds (less aggressive than before)
    setInterval(updateScanStatuses, 10000);
    
    // Update progress bars for running scans
    async function updateProgressBars() {
        const runningScans = document.querySelectorAll('tr[data-scan-status="running"]');
        
        for (const row of runningScans) {
            const jobId = row.dataset.scanId;
            const progressBar = row.querySelector('.scan-progress-bar');
            const progressText = row.querySelector('.scan-progress-text');
            
            if (!progressBar || !progressText) continue;
            
            try {
                const response = await fetch(`/api/scan/${jobId}/progress`);
                if (!response.ok) continue;
                
                const progress = await response.json();
                
                // Update progress bar
                progressBar.style.width = `${progress.progress_percentage || 0}%`;
                
                // Update text
                const urlsText = progress.total_urls > 0 
                    ? `${progress.urls_scanned || 0}/${progress.total_urls}` 
                    : 'Starting...';
                const findingsText = progress.vulnerabilities_found > 0 
                    ? ` ‚Ä¢ ${progress.vulnerabilities_found} findings` 
                    : '';
                progressText.textContent = `${progress.progress_percentage || 0}% ‚Ä¢ ${urlsText}${findingsText}`;
            } catch (error) {
                // Silently continue - scan may have just completed
            }
        }
    }
    
    // Update progress bars every 5 seconds
    setInterval(updateProgressBars, 5000);
    // Initial update
    updateProgressBars();

    async function stopScan(jobId) {
        if (!confirm('Are you sure you want to stop this scan?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/scan-stop/${jobId}`, {
                method: 'POST',
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Scan stopped successfully');
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Failed to stop scan'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    function toggleDetectorsList() {
        const list = document.getElementById('detectors-list');
        list.style.display = list.style.display === 'none' ? 'block' : 'none';
    }
    
    async function changeTier(tier) {
        try {
            const formData = new FormData();
            formData.append('tier', tier);
            
            const response = await fetch('/change-tier', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                // Reload page to show new tier limits
                window.location.reload();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Failed to change tier'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Intercept form submission to show tier errors
    document.querySelector('form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/scan', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                window.location.reload();
            } else if (response.status === 403) {
                const data = await response.json();
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = '‚ö†Ô∏è ' + data.detail;
                errorDiv.style.display = 'block';
            } else {
                alert('Error starting scan');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
    
    // Extra Scans Modal Functions
    function showBuyExtraScans() {
        document.getElementById('buyExtraScansModal').style.display = 'flex';
    }
    
    function closeBuyExtraScans() {
        document.getElementById('buyExtraScansModal').style.display = 'none';
    }
    
    async function buyExtraScans(packageName) {
        try {
            const formData = new FormData();
            formData.append('package', packageName);
            
            const response = await fetch('/api/billing/buy-extra-scans', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const data = await response.json();
                window.location.href = data.url;  // Redirect to Stripe Checkout
            } else {
                const data = await response.json();
                alert('Error: ' + (data.detail || 'Failed to create checkout session'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Close modal when clicking outside
    document.getElementById('buyExtraScansModal')?.addEventListener('click', function(e) {
        if (e.target.id === 'buyExtraScansModal') {
            closeBuyExtraScans();
        }
    });
    
    // Check for success/cancel messages
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('extra_scans_success') === 'true') {
        alert('‚úÖ Extra scans purchased successfully! You can now continue scanning.');
        // Remove query parameter
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    if (urlParams.get('extra_scans_cancel') === 'true') {
        alert('‚ùå Purchase cancelled. You can try again anytime.');
        // Remove query parameter
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Modal functions
    function closeModal() {
        document.getElementById('scanDetailsModal').style.display = 'none';
        // Stop log streaming
        if (window.logEventSource) {
            window.logEventSource.close();
            window.logEventSource = null;
        }
    }
    
    function toggleTerminal() {
        const content = document.getElementById('terminalContent');
        const btn = document.getElementById('terminalToggleBtn');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            btn.textContent = '‚ñº Hide';
        } else {
            content.style.display = 'none';
            btn.textContent = '‚ñ∂ Show';
        }
    }
    
    async function viewScanDetails(jobId) {
        try {
            const response = await fetch(`/api/scan/${jobId}/details`);
            if (!response.ok) throw new Error('Failed to fetch scan details');
            
            const scan = await response.json();
            
            // Fetch progress data if scan is running
            let progressHTML = '';
            if (scan.status === 'running') {
                try {
                    const progressResponse = await fetch(`/api/scan/${jobId}/progress`);
                    if (progressResponse.ok) {
                        const progress = await progressResponse.json();
                        const percentage = progress.progress_percentage || 0;
                        const etaText = progress.eta_seconds ? formatDuration(progress.eta_seconds) : 'calculating...';
                        
                        progressHTML = `
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-size: 0.85rem; color: #9ca3af;">Scan Progress</div>
                                <div style="font-size: 1rem; font-weight: 600; color: #3b82f6;">${percentage}%</div>
                            </div>
                            <div style="width: 100%; height: 8px; background: #1f2937; border-radius: 4px; overflow: hidden; margin-bottom: 0.75rem;">
                                <div style="height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: ${percentage}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; font-size: 0.8rem;">
                                <div>
                                    <div style="color: #6b7280;">URLs Scanned</div>
                                    <div style="color: #e5e7eb; font-weight: 600;">${progress.urls_scanned || 0} / ${progress.total_urls || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280;">Findings</div>
                                    <div style="color: #ef4444; font-weight: 600;">${progress.vulnerabilities_found || 0}</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280;">ETA</div>
                                    <div style="color: #e5e7eb; font-weight: 600;">${etaText}</div>
                                </div>
                            </div>
                        </div>
                        `;
                        
                        // Start progress polling
                        startProgressPolling(jobId);
                    }
                } catch (e) {
                    console.error('Failed to fetch progress:', e);
                }
            }
            
            // Fetch findings if scan is completed
            let findingsHTML = '';
            let findingsTotal = 0; // Track total findings from API
            if (scan.status === 'completed') {
                try {
                    const findingsResponse = await fetch(`/api/scan/${jobId}/findings`);
                    if (findingsResponse.ok) {
                        const findings = await findingsResponse.json();
                        findingsTotal = findings.total; // Store total from API
                        
                        if (findings.total > 0) {
                            const severityColors = {
                                critical: '#dc2626',
                                high: '#ea580c',
                                medium: '#f59e0b',
                                low: '#10b981',
                                info: '#3b82f6'
                            };
                            
                            const severityIcons = {
                                critical: 'üî¥',
                                high: 'üü†',
                                medium: 'üü°',
                                low: 'üü¢',
                                info: 'üîµ'
                            };
                            
                            findingsHTML = `
                            <div style="border-top: 1px solid #374151; padding-top: 1rem; margin-top: 1rem;">
                                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #f3f4f6;">
                                    üîç Findings Breakdown
                                </h3>
                                
                                <!-- Severity Summary -->
                                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                    ${findings.critical.length > 0 ? `
                                    <div style="background: rgba(220, 38, 38, 0.1); border: 1px solid ${severityColors.critical}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">Critical</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.critical};">${findings.critical.length}</div>
                                    </div>
                                    ` : ''}
                                    ${findings.high.length > 0 ? `
                                    <div style="background: rgba(234, 88, 12, 0.1); border: 1px solid ${severityColors.high}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">High</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.high};">${findings.high.length}</div>
                                    </div>
                                    ` : ''}
                                    ${findings.medium.length > 0 ? `
                                    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid ${severityColors.medium}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">Medium</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.medium};">${findings.medium.length}</div>
                                    </div>
                                    ` : ''}
                                    ${findings.low.length > 0 ? `
                                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid ${severityColors.low}; border-radius: 0.5rem; padding: 0.5rem 0.75rem; flex: 1; min-width: 100px;">
                                        <div style="font-size: 0.75rem; color: #9ca3af;">Low</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${severityColors.low};">${findings.low.length}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Findings List -->
                                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #374151; border-radius: 0.5rem; background: #0f172a;">
                                    ${['critical', 'high', 'medium', 'low', 'info'].map(severity => {
                                        if (findings[severity].length === 0) return '';
                                        return `
                                        <div style="border-bottom: 1px solid #1f2937; padding: 0.75rem;">
                                            <div style="font-size: 0.8rem; font-weight: 600; color: ${severityColors[severity]}; margin-bottom: 0.5rem;">
                                                ${severityIcons[severity]} ${severity.toUpperCase()} (${findings[severity].length})
                                            </div>
                                            ${findings[severity].slice(0, 3).map(finding => `
                                                <div style="margin-left: 1.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 0.25rem;">
                                                    <div style="font-size: 0.75rem; color: #f3f4f6; font-weight: 500;">${finding.type}</div>
                                                    <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;">
                                                        <span style="color: #60a5fa;">üìç ${finding.url}</span>
                                                    </div>
                                                    <div style="font-size: 0.7rem; color: #d1d5db; margin-top: 0.25rem;">
                                                        ${finding.description}
                                                    </div>
                                                    <div style="font-size: 0.65rem; color: #6b7280; margin-top: 0.25rem;">
                                                        Detector: ${finding.detector} | Confidence: ${finding.confidence}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${findings[severity].length > 3 ? `
                                                <div style="margin-left: 1.5rem; font-size: 0.7rem; color: #6b7280; font-style: italic;">
                                                    ...and ${findings[severity].length - 3} more
                                                </div>
                                            ` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            `;
                        }
                    }
                } catch (e) {
                    console.error('Failed to fetch findings:', e);
                }
            }
            
            const modalContent = `
                ${progressHTML}
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Job ID</div>
                        <div style="font-family: monospace; font-size: 0.85rem;">${scan.job_id}</div>
                    </div>
                    <div>
                        <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Target</div>
                        <div>${scan.target}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Mode</div>
                            <div><span class="tag" style="background: #1f2937; padding: 0.25rem 0.6rem; font-size: 0.75rem;">${scan.mode}</span></div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Status</div>
                            <div><span class="tag status-${scan.status}" style="padding: 0.25rem 0.6rem; font-size: 0.75rem;">${scan.status}</span></div>
                        </div>
                    </div>
                    <div>
                        <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Vulnerabilities Found</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${(findingsTotal || scan.vulnerabilities_found) > 0 ? '#ef4444' : '#22c55e'};">
                            ${findingsTotal || scan.vulnerabilities_found || 0}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Started</div>
                            <div style="font-size: 0.85rem;">${scan.started_at ? new Date(scan.started_at).toLocaleString() : 'N/A'}</div>
                        </div>
                        ${scan.completed_at ? `
                        <div>
                            <div style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 0.25rem;">Completed</div>
                            <div style="font-size: 0.85rem;">${new Date(scan.completed_at).toLocaleString()}</div>
                        </div>
                        ` : ''}
                    </div>
                    ${scan.report_path ? `
                    <div>
                        <a href="${scan.report_path}?v=${Date.now()}" target="_blank" class="btn-primary" style="display: inline-block; padding: 0.5rem 1rem; text-decoration: none; border-radius: 0.4rem;">
                            üìÑ View Full Report
                        </a>
                    </div>
                    ` : ''}
                    
                    ${findingsHTML}
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('scanDetailsModal').style.display = 'flex';
            
            // Show terminal and start streaming logs if scan is running or has log file
            if (scan.log_path) {
                document.getElementById('terminalContainer').style.display = 'block';
                document.getElementById('terminalContent').style.display = 'block';
                startLogStreaming(jobId);
            } else {
                document.getElementById('terminalContainer').style.display = 'none';
            }
        } catch (error) {
            alert('Error loading scan details: ' + error.message);
        }
    }
    
    // Helper function to format duration in human-readable format
    function formatDuration(seconds) {
        if (seconds < 60) return `${seconds}s`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${mins}m`;
    }
    
    // Poll progress updates
    let progressPollingInterval = null;
    function startProgressPolling(jobId) {
        // Clear existing interval
        if (progressPollingInterval) {
            clearInterval(progressPollingInterval);
        }
        
        progressPollingInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/scan/${jobId}/progress`);
                if (!response.ok) {
                    clearInterval(progressPollingInterval);
                    return;
                }
                
                const progress = await response.json();
                
                // Update progress bar and stats if modal is still open
                const modal = document.getElementById('scanDetailsModal');
                if (modal.style.display === 'flex') {
                    viewScanDetails(jobId); // Refresh entire modal
                } else {
                    clearInterval(progressPollingInterval);
                }
                
                // Stop polling if scan completed
                if (progress.status !== 'running') {
                    clearInterval(progressPollingInterval);
                }
            } catch (error) {
                console.error('Progress polling error:', error);
            }
        }, 5000); // Poll every 5 seconds
    }
    
    function startLogStreaming(jobId) {
        const logContainer = document.getElementById('logLines');
        logContainer.innerHTML = '<span style="color: #fbbf24;">[Connecting to scan output...]</span>';
        
        // Close existing connection if any
        if (window.logEventSource) {
            window.logEventSource.close();
        }
        
        // Get token from cookie for authentication
        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        };
        
        const token = getCookie('access_token');
        
        if (!token) {
            logContainer.innerHTML = '<span style="color: #ef4444;">[Authentication error: No token found. Please refresh the page.]</span>';
            return;
        }
        
        // Create EventSource for Server-Sent Events with token in URL
        const url = `/api/scan/${jobId}/stream-log?token=${encodeURIComponent(token)}`;
        const eventSource = new EventSource(url);
        window.logEventSource = eventSource;
        
        let lineCount = 0;
        const maxLines = 500; // Limit to last 500 lines
        
        eventSource.onmessage = function(event) {
            const line = event.data;
            
            // Create line element
            const lineDiv = document.createElement('div');
            lineDiv.textContent = line;
            
            // Color coding based on content
            if (line.includes('[ERROR]') || line.includes('Error') || line.includes('FAIL')) {
                lineDiv.style.color = '#ef4444';
            } else if (line.includes('[SUCCESS]') || line.includes('Found') || line.includes('Detected')) {
                lineDiv.style.color = '#22c55e';
            } else if (line.includes('[WARN]') || line.includes('Warning')) {
                lineDiv.style.color = '#fbbf24';
            } else if (line.includes('[INFO]')) {
                lineDiv.style.color = '#3b82f6';
            }
            
            if (lineCount === 0) {
                // First line, replace "Connecting" message
                logContainer.innerHTML = '';
            }
            
            logContainer.appendChild(lineDiv);
            lineCount++;
            
            // Remove old lines if too many
            if (lineCount > maxLines) {
                logContainer.removeChild(logContainer.firstChild);
                lineCount--;
            }
            
            // Auto-scroll to bottom
            const terminal = document.getElementById('terminalContent');
            terminal.scrollTop = terminal.scrollHeight;
        };
        
        eventSource.onerror = function(error) {
            // Suppress normal disconnection errors (scan completed)
            if (eventSource.readyState === EventSource.CLOSED) {
                // Connection closed permanently - scan likely completed
                if (lineCount > 0) {
                    // Only show message if we received logs
                    logContainer.innerHTML += '<div style="color: #10b981;">[‚úì Scan completed - log stream closed]</div>';
                }
            }
            // EventSource will automatically retry for temporary errors
        };
        
        eventSource.onopen = function() {
            // Connection opened - no console log needed
        };
    }
    
    async function exportScan(jobId, format) {
        try {
            const endpoint = format === 'json' ? 
                `/api/scan/${jobId}/export/json` : 
                `/api/scan/${jobId}/export/markdown`;
            
            window.open(endpoint, '_blank');
        } catch (error) {
            alert('Error exporting scan: ' + error.message);
        }
    }
    
    async function deleteScan(jobId) {
        if (!confirm('‚ö†Ô∏è Are you sure you want to delete this scan? This cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/scan/${jobId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.innerHTML = '‚úÖ Scan deleted successfully';
                successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 9999; box-shadow: 0 10px 25px rgba(34, 197, 94, 0.5);';
                document.body.appendChild(successMsg);
                
                // Reload after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                const data = await response.json();
                alert('‚ùå Error: ' + (data.detail || 'Failed to delete scan'));
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }
    
    async function validateScope() {
        const scopeFile = document.getElementById('scope_file').value;
        if (!scopeFile) {
            alert('‚ö†Ô∏è Please enter a scope file path');
            return;
        }
        
        try {
            const response = await fetch('/api/validate-scope', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({scope_file: scopeFile})
            });
            
            if (response.ok) {
                const data = await response.json();
                document.getElementById('in-scope-count').textContent = data.in_scope_count;
                document.getElementById('out-scope-count').textContent = data.out_of_scope_count;
                document.getElementById('scope-validation').style.display = 'block';
                
                if (data.out_of_scope_count > 0) {
                    const warning = document.createElement('div');
                    warning.style.cssText = 'margin-top: 0.5rem; color: #fbbf24; font-size: 0.75rem;';
                    warning.innerHTML = '‚ö†Ô∏è Out-of-scope domains will be filtered out during scan';
                    document.getElementById('scope-validation').appendChild(warning);
                }
            } else {
                const data = await response.json();
                alert('‚ùå Error: ' + (data.detail || 'Failed to validate scope'));
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }
    
    // Close modal when clicking outside
    document.getElementById('scanDetailsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
</body>
</html>
