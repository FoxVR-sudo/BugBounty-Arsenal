{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}" />
    <title>Custom Scan - BugBounty Arsenal</title>
    <script src="{% static 'js/api-client.js' %}"></script>
        <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Comic Neue', 'Comic Sans MS', cursive;
            background: linear-gradient(135deg, #d4a5d4 0%, #d4c5a5 25%, #a5c5d4 50%, #c5d4a5 75%, #d4a5d4 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            color: #2d2d2d;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle, #ff6b9d 1px, transparent 1px),
                radial-gradient(circle, #6eb5ff 1px, transparent 1px);
            background-size: 30px 30px, 40px 40px;
            background-position: 0 0, 15px 15px;
            opacity: 0.25;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #ff6b9d, #ffd93d, #6eb5ff);
            border-bottom: 6px solid #2d2d2d;
            box-shadow: 0 8px 0 #2d2d2d, 0 12px 24px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
            font-family: 'Bangers', cursive;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #fff;
            text-shadow: 
                4px 4px 0 #2d2d2d,
                8px 8px 0 #ff6b9d,
                12px 12px 20px rgba(0, 0, 0, 0.4);
            transform: rotate(-2deg);
            position: relative;
            z-index: 2;
        }
        .dashboard-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: #0b1120; border-right: 1px solid #1f2937; overflow-y: auto; }
        .sidebar-section { padding: 1.5rem 1rem; border-bottom: 1px solid #1f2937; }
        .sidebar-section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #6b7280; margin-bottom: 0.75rem; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu-item { margin-bottom: 0.25rem; }
        .sidebar-menu-item a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; text-decoration: none; color: #9ca3af; transition: all 0.2s; }
        .sidebar-menu-item a:hover { background: #1f2937; color: #e5e7eb; }
        .sidebar-menu-item a.active { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-weight: 500; }
        .sidebar-menu-item .icon { font-size: 1.2rem; width: 24px; text-align: center; }
        .detector-list { padding: 0.5rem; max-height: 200px; overflow-y: auto; }
        .detector-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.85rem; color: #9ca3af; }
        .detector-item .dot { width: 6px; height: 6px; border-radius: 50%; }
        .detector-item.active .dot { background: #22c55e; }
        .detector-item.passive .dot { background: #3b82f6; }
        main { flex: 1; overflow-y: auto; padding: 2rem; }
        .card { background: linear-gradient(135deg, #0d1625, #0b1120); border: 1px solid #1f2937; padding: 2rem; border-radius: 0.75rem; margin-bottom: 2rem; }
        h2 { margin-bottom: 1.5rem; font-size: 1.4rem; }
        h3 { margin-bottom: 1rem; font-size: 1.1rem; color: #e5e7eb; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.95rem; color: #9ca3af; }
        input, textarea, select { width: 100%; padding: 0.75rem; background: #0d1625; border: 1px solid #374151; border-radius: 0.5rem; color: #e5e7eb; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }
        .btn-secondary { background: #374151; color: #e5e7eb; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .help-text { font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem; }
        .detector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem; margin-bottom: 2rem; }
        .detector-card { background: #0d1625; border: 1px solid #374151; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.2s; }
        .detector-card:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        .detector-card.selected { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .detector-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .detector-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .detector-name { font-weight: 600; font-size: 0.95rem; color: #e5e7eb; }
        .detector-type { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem; }
        .type-active { background: #22c55e; color: #000; }
        .type-passive { background: #3b82f6; color: white; }
        .detector-desc { font-size: 0.85rem; color: #9ca3af; }
        .quick-actions { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .profile-section { background: #0d1625; border: 1px solid #374151; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem; }
    </style>
</head>
<body>

<header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>‚öôÔ∏è Custom Security Scan</h1>
            <p style="color: #9ca3af; font-size: 0.9rem; margin-top: 0.25rem;">Build your own scan with manual detector selection and custom payloads</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">üè† Dashboard</a>
            <a href="{% url 'results-page' %}" class="btn btn-secondary">üìä Results</a>
            <a href="{% url 'admin-panel' %}" class="btn btn-secondary">‚öôÔ∏è Admin</a>
            <form method="POST" action="{% url 'logout' %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-secondary">üö™ Logout</button>
            </form>
        </div>
    </div>
</header>

<div class="dashboard-container">
    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-section-title">Scan Types</div>
            <ul class="sidebar-menu">
                <li class="sidebar-menu-item"><a href="{% url 'dashboard' %}"><span class="icon">üåê</span><span>Web Security</span></a></li>
                <li class="sidebar-menu-item"><a href="{% url 'api-scan' %}"><span class="icon">üîå</span><span>API Security</span></a></li>
                <li class="sidebar-menu-item"><a href="{% url 'vulnerability-scan' %}"><span class="icon">üêõ</span><span>Vulnerability Assessment</span></a></li>
                <li class="sidebar-menu-item"><a href="{% url 'mobile-scan' %}"><span class="icon">üì±</span><span>Mobile App Security</span></a></li>
                <li class="sidebar-menu-item"><a href="{% url 'custom-scan' %}" class="active"><span class="icon">‚öôÔ∏è</span><span>Custom Scan</span></a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">All Detectors (39)</div>
            <div style="padding: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                <div style="margin-bottom: 0.5rem;">‚úÖ Active: <span id="activeCount">0</span>/30</div>
                <div>‚úÖ Passive: <span id="passiveCount">0</span>/9</div>
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #374151;">
                    <strong style="color: #22c55e;">Total Selected: <span id="totalCount">0</span>/39</strong>
                </div>
            </div>
        </div>
    </aside>

    <main>
        <section class="card">
            <h2>üéØ Target Configuration</h2>
            
            <form id="customScanForm">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>Target URL *</label>
                    <input type="url" id="targetUrl" placeholder="https://example.com" required>
                </div>
                
                <div class="form-group">
                    <label>Scan Name (Optional)</label>
                    <input type="text" id="scanName" placeholder="My Custom Security Scan">
                    <p class="help-text">Give your scan a memorable name</p>
                </div>
                
                <div class="form-group">
                    <label>Scan Intensity</label>
                    <select id="scanIntensity">
                        <option value="light">Light - Quick test</option>
                        <option value="normal" selected>Normal - Balanced</option>
                        <option value="aggressive">Aggressive - Deep scan</option>
                        <option value="brutal">Brutal - Maximum payload testing</option>
                    </select>
                </div>
            </form>
        </section>
        
        <section class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">üß© Select Detectors (39 Available)</h2>
                <div class="quick-actions">
                    <button class="btn btn-secondary btn-small" onclick="selectAll()">‚úÖ Select All</button>
                    <button class="btn btn-secondary btn-small" onclick="deselectAll()">‚ùå Deselect All</button>
                    <button class="btn btn-secondary btn-small" onclick="selectActive()">üü¢ Active Only</button>
                    <button class="btn btn-secondary btn-small" onclick="selectPassive()">üîµ Passive Only</button>
                </div>
            </div>
            
            <h3>üü¢ Active Detectors (30) - HTTP Request Based</h3>
            <div class="detector-grid" id="activeDetectors">
                <!-- Active detectors populated by JS -->
            </div>
            
            <h3>üîµ Passive Detectors (9) - Response Analysis</h3>
            <div class="detector-grid" id="passiveDetectors">
                <!-- Passive detectors populated by JS -->
            </div>
        </section>
        
        <section class="card">
            <h2>üíæ Save Scan Profile</h2>
            <div class="profile-section">
                <p style="color: #9ca3af; margin-bottom: 1rem;">Save this detector configuration for future use</p>
                <div style="display: flex; gap: 1rem;">
                    <input type="text" id="profileName" placeholder="Profile Name (e.g., Quick Web Scan)" style="flex: 1;">
                    <button class="btn btn-secondary" onclick="saveProfile()">üíæ Save Profile</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" class="btn btn-primary" onclick="startCustomScan()">üöÄ Start Custom Scan</button>
                <button type="button" class="btn btn-secondary" onclick="resetCustomForm()">üîÑ Reset</button>
            </div>
        </section>
    </main>
</div>

<script>
const activeDetectors = [
    {name: 'XSS Pattern Detector', desc: 'Cross-site scripting vulnerability detection'},
    {name: 'SQL Injection Detector', desc: 'SQL injection pattern matching'},
    {name: 'SSRF Detector', desc: 'Server-side request forgery detection'},
    {name: 'Advanced SSRF Detector', desc: 'Advanced SSRF with blind payloads'},
    {name: 'SSRF OOB Detector', desc: 'Out-of-band SSRF detection'},
    {name: 'XXE Detector', desc: 'XML external entity injection'},
    {name: 'LFI Detector', desc: 'Local file inclusion vulnerability'},
    {name: 'Command Injection Detector', desc: 'OS command injection testing'},
    {name: 'SSTI Detector', desc: 'Server-side template injection'},
    {name: 'Open Redirect Detector', desc: 'Open redirect vulnerability'},
    {name: 'IDOR Detector', desc: 'Insecure direct object reference'},
    {name: 'JWT Detector', desc: 'JWT token security analysis'},
    {name: 'JWT Vulnerability Scanner', desc: 'Advanced JWT exploitation'},
    {name: 'CSRF Detector', desc: 'Cross-site request forgery'},
    {name: 'Auth Bypass Detector', desc: 'Authentication bypass attempts'},
    {name: 'File Upload Detector', desc: 'Insecure file upload testing'},
    {name: 'Brute Force Detector', desc: 'Login brute force testing'},
    {name: 'GraphQL Detector', desc: 'GraphQL endpoint discovery'},
    {name: 'GraphQL Injection Detector', desc: 'GraphQL injection testing'},
    {name: 'NoSQL Injection Detector', desc: 'NoSQL database injection'},
    {name: 'Rate Limit Bypass Detector', desc: 'Rate limiting bypass'},
    {name: 'Race Condition Detector', desc: 'Race condition vulnerability'},
    {name: 'Prototype Pollution Detector', desc: 'JavaScript prototype pollution'},
    {name: 'Cache Poisoning Detector', desc: 'Web cache poisoning'},
    {name: 'Header Injection Detector', desc: 'HTTP header injection'},
    {name: 'OAuth Detector', desc: 'OAuth security testing'},
    {name: 'Subdomain Takeover Detector', desc: 'Subdomain takeover check'},
    {name: 'API Security Detector', desc: 'API security analysis'},
    {name: 'Fuzz Detector', desc: 'Fuzzing various inputs'},
    {name: 'CVE Database Detector', desc: 'Known CVE matching'}
];

const passiveDetectors = [
    {name: 'Security Headers Detector', desc: 'Missing security headers'},
    {name: 'CORS Detector', desc: 'CORS misconfiguration'},
    {name: 'Secret Detector', desc: 'Exposed secrets and keys'},
    {name: 'Reflection Detector', desc: 'Input reflection analysis'},
    {name: 'Dir Listing Detector', desc: 'Directory listing exposure'},
    {name: 'Injector', desc: 'Passive injection analysis'},
    {name: 'Interactsh Client', desc: 'OOB interaction monitoring'},
    {name: 'Registry', desc: 'Detector registry system'},
    {name: '__pycache__', desc: 'Internal caching system'}
];

function createDetectorCard(detector, type) {
    const id = detector.name.toLowerCase().replace(/\s+/g, '_');
    return `
        <div class="detector-card" onclick="toggleDetector('${id}', this)">
            <div class="detector-header">
                <input type="checkbox" id="${id}" class="detector-checkbox ${type}" onclick="event.stopPropagation();">
                <div>
                    <span class="detector-name">${detector.name}</span>
                    <span class="detector-type type-${type}">${type.toUpperCase()}</span>
                </div>
            </div>
            <div class="detector-desc">${detector.desc}</div>
        </div>
    `;
}

// Populate detectors
document.getElementById('activeDetectors').innerHTML = activeDetectors.map(d => createDetectorCard(d, 'active')).join('');
document.getElementById('passiveDetectors').innerHTML = passiveDetectors.map(d => createDetectorCard(d, 'passive')).join('');

function toggleDetector(id, card) {
    const checkbox = document.getElementById(id);
    checkbox.checked = !checkbox.checked;
    card.classList.toggle('selected', checkbox.checked);
    updateCounts();
}

function updateCounts() {
    const activeCount = document.querySelectorAll('.detector-checkbox.active:checked').length;
    const passiveCount = document.querySelectorAll('.detector-checkbox.passive:checked').length;
    document.getElementById('activeCount').textContent = activeCount;
    document.getElementById('passiveCount').textContent = passiveCount;
    document.getElementById('totalCount').textContent = activeCount + passiveCount;
}

function selectAll() {
    document.querySelectorAll('.detector-checkbox').forEach(cb => {
        cb.checked = true;
        cb.closest('.detector-card').classList.add('selected');
    });
    updateCounts();
}

function deselectAll() {
    document.querySelectorAll('.detector-checkbox').forEach(cb => {
        cb.checked = false;
        cb.closest('.detector-card').classList.remove('selected');
    });
    updateCounts();
}

function selectActive() {
    deselectAll();
    document.querySelectorAll('.detector-checkbox.active').forEach(cb => {
        cb.checked = true;
        cb.closest('.detector-card').classList.add('selected');
    });
    updateCounts();
}

function selectPassive() {
    deselectAll();
    document.querySelectorAll('.detector-checkbox.passive').forEach(cb => {
        cb.checked = true;
        cb.closest('.detector-card').classList.add('selected');
    });
    updateCounts();
}

function saveProfile() {
    const profileName = document.getElementById('profileName').value;
    if (!profileName) {
        alert('Please enter a profile name');
        return;
    }
    
    const selectedDetectors = Array.from(document.querySelectorAll('.detector-checkbox:checked'))
        .map(cb => cb.id);
    
    localStorage.setItem('scan_profile_' + profileName, JSON.stringify({
        detectors: selectedDetectors,
        intensity: document.getElementById('scanIntensity').value
    }));
    
    alert('‚úÖ Profile saved: ' + profileName);
}

function resetCustomForm() {
    document.getElementById('customScanForm').reset();
    deselectAll();
}

async function startCustomScan() {
    const target = document.getElementById('targetUrl').value;
    if (!target) {
        alert('Please enter a target URL');
        return;
    }
    
    const selectedDetectors = Array.from(document.querySelectorAll('.detector-checkbox:checked'))
        .map(cb => cb.id);
    
    if (selectedDetectors.length === 0) {
        alert('Please select at least one detector');
        return;
    }
    
    const scanData = {
        scan_type: 'custom',
        target: target,
        scan_name: document.getElementById('scanName').value,
        intensity: document.getElementById('scanIntensity').value,
        detectors: selectedDetectors
    };
    
    try {
        const response = await fetch('/api/scans/start/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(scanData)
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('‚úÖ Custom scan started with ' + selectedDetectors.length + ' detectors! Scan ID: ' + result.scan_id);
            window.location.href = '{% url "dashboard" %}';
        } else {
            alert('‚ùå Error starting scan');
        }
    } catch (error) {
        alert('‚ùå Network error: ' + error.message);
    }
}

// Add event listeners to checkboxes
document.querySelectorAll('.detector-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
        this.closest('.detector-card').classList.toggle('selected', this.checked);
        updateCounts();
    });
});
</script>

</body>
</html>
