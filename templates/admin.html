{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - BugBounty Arsenal</title>
    <script>
        // Django API URLs configuration for Admin Panel
        window.ADMIN_API_URLS = {
            stats: '/api/admin/stats/',
            users: '/api/admin/users/',
            plans: '/api/admin/plans/',
            scans: '/api/admin/scans/',
            auditLogs: '/api/admin/audit-logs/',
            databaseTables: '/api/admin/database/tables/',
            databaseInfo: '/api/admin/database/info/',
            databaseQuery: '/api/admin/database/query/',
            databaseTable: '/api/admin/database/table/',
            databaseBackup: '/api/admin/database/backup/'
        };
        window.CSRF_TOKEN = '{{ csrf_token }}';
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        window.getCsrfToken = () => getCookie('csrftoken') || window.CSRF_TOKEN;
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .admin-container { display: flex; height: 100vh; }
        .admin-sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 2px 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }
        .admin-header {
            padding: 30px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .admin-header h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .admin-header .role-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }
        .admin-nav { flex: 1; overflow-y: auto; padding: 20px 0; }
        .nav-section { margin-bottom: 25px; }
        .nav-section-title {
            padding: 0 25px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #999;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { background: rgba(102, 126, 234, 0.1); border-left-color: #667eea; }
        .nav-item.active {
            background: rgba(102, 126, 234, 0.15);
            border-left-color: #667eea;
            font-weight: 600;
            color: #667eea;
        }
        .nav-item .icon { margin-right: 12px; font-size: 18px; width: 24px; text-align: center; }
        .nav-footer { padding: 20px 25px; border-top: 1px solid #eee; }
        .nav-footer .btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .nav-footer .btn:hover { background: #e0e0e0; }
        .admin-main { flex: 1; overflow-y: auto; padding: 40px; }
        .content-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .content-header h2 { font-size: 28px; color: #333; margin-bottom: 8px; }
        .content-header p { color: #666; font-size: 14px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-card .label {
            font-size: 13px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        .content-panel { display: none; }
        .content-panel.active { display: block; }
        .panel-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .panel-section h3 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table thead { background: #f9fafb; }
        .data-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }
        .data-table tbody tr:hover { background: #f9fafb; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.success { background: #d1fae5; color: #065f46; }
        .badge.danger { background: #fee2e2; color: #991b1b; }
        .loading { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-sidebar">
            <div class="admin-header">
                <h1>üõ°Ô∏è Admin Panel</h1>
                <div class="role-badge">ADMINISTRATOR</div>
            </div>
            <div class="admin-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <div class="nav-item active" data-panel="dashboard">
                        <span class="icon">üìä</span><span>Dashboard</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <div class="nav-item" data-panel="users">
                        <span class="icon">üë•</span><span>Users</span>
                    </div>
                    <div class="nav-item" data-panel="plans">
                        <span class="icon">üí≥</span><span>Plans</span>
                    </div>
                    <div class="nav-item" data-panel="scans">
                        <span class="icon">üîç</span><span>Scans</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <div class="nav-item" data-panel="audit">
                        <span class="icon">üìù</span><span>Audit Logs</span>
                    </div>
                    <div class="nav-item" data-panel="database">
                        <span class="icon">üíæ</span><span>Database</span>
                    </div>
                </div>
            </div>
            <div class="nav-footer">
                <button class="btn" onclick="window.location.href='/dashboard'">‚Üê Back to Dashboard</button>
            </div>
        </div>
        <div class="admin-main">
            <div class="content-panel active" id="dashboard-panel">
                <div class="content-header">
                    <h2>Dashboard Overview</h2>
                    <p>Platform statistics and monitoring</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="label">Total Users</div><div class="value" id="stat-users">0</div></div>
                    <div class="stat-card"><div class="label">Active Subscriptions</div><div class="value" id="stat-subs">0</div></div>
                    <div class="stat-card"><div class="label">Scans Today</div><div class="value" id="stat-scans">0</div></div>
                    <div class="stat-card"><div class="label">Monthly Revenue</div><div class="value" id="stat-revenue">$0</div></div>
                </div>
            </div>
            <div class="content-panel" id="users-panel">
                <div class="content-header">
                    <h2>User Management</h2>
                    <p>Manage all platform users</p>
                </div>
                <div class="panel-section">
                    <h3>All Users</h3>
                    <div id="users-list"><div class="loading">Loading...</div></div>
                </div>
            </div>
            <div class="content-panel" id="plans-panel">
                <div class="content-header">
                    <h2>Plans Management</h2>
                    <p>Manage subscription plans</p>
                </div>
                <div class="panel-section">
                    <h3>Plans</h3>
                    <div id="plans-list"><div class="loading">Loading...</div></div>
                </div>
            </div>
            <div class="content-panel" id="scans-panel">
                <div class="content-header">
                    <h2>Scans Management</h2>
                    <p>Monitor all scans</p>
                </div>
                <div class="panel-section">
                    <h3>All Scans</h3>
                    <div id="scans-list"><div class="loading">Loading...</div></div>
                </div>
            </div>
            <div class="content-panel" id="audit-panel">
                <div class="content-header">
                    <h2>Audit Logs</h2>
                    <p>Security events</p>
                </div>
                <div class="panel-section">
                    <h3>Recent Events</h3>
                    <div id="audit-list"><div class="loading">Loading...</div></div>
                </div>
            </div>
            <div class="content-panel" id="database-panel">
                <div class="content-header">
                    <h2>Database Management</h2>
                    <p>Direct database access and SQL queries</p>
                </div>
                
                <!-- Tables Overview -->
                <div class="panel-section">
                    <h3>üìä Tables Overview</h3>
                    <div id="tables-list"></div>
                </div>
                
                <!-- SQL Query Interface -->
                <div class="panel-section">
                    <h3>üîç SQL Query (SELECT only)</h3>
                    <textarea id="sql-query" placeholder="SELECT * FROM users LIMIT 10;" style="width:100%; height:100px; font-family:monospace; padding:10px; border:1px solid #ddd; border-radius:4px;"></textarea>
                    <button class="btn-primary" onclick="executeQuery()" style="margin-top:10px;">‚ñ∂Ô∏è Execute Query</button>
                    <div id="query-result" style="margin-top:20px;"></div>
                </div>
                
                <!-- Table Data Viewer -->
                <div class="panel-section">
                    <h3>üìã Table Data</h3>
                    <select id="table-selector" onchange="loadTableData(this.value)" style="padding:8px; margin-bottom:15px;">
                        <option value="">Select a table...</option>
                    </select>
                    <div id="table-data"></div>
                </div>
                
                <!-- Database Operations -->
                <div class="panel-section">
                    <h3>üíæ Operations</h3>
                    <button class="btn-primary" onclick="backupDB()">Backup Database</button>
                    <div id="db-info" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const panel = item.dataset.panel;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(panel + '-panel').classList.add('active');
                loadPanelData(panel);
            });
        });
        
        async function loadPanelData(panel) {
            switch(panel) {
                case 'dashboard': await loadDashboard(); break;
                case 'users': await loadUsers(); break;
                case 'plans': await loadPlans(); break;
                case 'scans': await loadScans(); break;
                case 'audit': await loadAudit(); break;
                case 'database': await loadDatabase(); break;
            }
        }
        
        async function loadDashboard() {
            const resp = await fetch(window.ADMIN_API_URLS.stats);
            const data = await resp.json();
            document.getElementById('stat-users').textContent = data.total_users || 0;
            document.getElementById('stat-subs').textContent = data.active_subscriptions || 0;
            document.getElementById('stat-scans').textContent = data.scans_today || 0;
            document.getElementById('stat-revenue').textContent = '$' + (data.monthly_revenue || 0);
        }
        
        async function loadUsers() {
            const resp = await fetch(window.ADMIN_API_URLS.users);
            const data = await resp.json();
            let html = '<table class="data-table"><thead><tr><th>Email</th><th>Plan</th><th>Status</th><th>Created</th></tr></thead><tbody>';
            data.users.forEach(u => {
                html += `<tr>
                    <td>${u.email}</td>
                    <td><span class="badge ${u.subscription?.tier === 'pro' ? 'success' : 'info'}">${(u.subscription?.tier || 'free').toUpperCase()}</span></td>
                    <td><span class="badge ${u.is_active ? 'success' : 'danger'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('users-list').innerHTML = html;
        }
        
        async function loadPlans() {
            const resp = await fetch(window.ADMIN_API_URLS.plans);
            const data = await resp.json();
            let html = '<table class="data-table"><thead><tr><th>Name</th><th>Price</th><th>Subscribers</th><th>Status</th></tr></thead><tbody>';
            data.forEach(p => {
                html += `<tr>
                    <td><strong>${p.display_name}</strong></td>
                    <td>$${p.price_monthly}/mo</td>
                    <td>${p.subscribers}</td>
                    <td><span class="badge ${p.is_active ? 'success' : 'danger'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('plans-list').innerHTML = html;
        }
        
        async function loadScans() {
            const resp = await fetch(window.ADMIN_API_URLS.scans);
            const data = await resp.json();
            let html = '<table class="data-table"><thead><tr><th>Job ID</th><th>User</th><th>Target</th><th>Status</th><th>Date</th></tr></thead><tbody>';
            data.scans.forEach(s => {
                html += `<tr>
                    <td><code>${s.job_id.substr(0,8)}</code></td>
                    <td>${s.user_email}</td>
                    <td>${s.target}</td>
                    <td><span class="badge ${s.status === 'completed' ? 'success' : 'info'}">${s.status}</span></td>
                    <td>${new Date(s.created_at).toLocaleDateString()}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('scans-list').innerHTML = html;
        }
        
        async function loadAudit() {
            const resp = await fetch(window.ADMIN_API_URLS.auditLogs);
            const data = await resp.json();
            let html = '<table class="data-table"><thead><tr><th>Event</th><th>Description</th><th>IP</th><th>Date</th></tr></thead><tbody>';
            data.logs.forEach(l => {
                html += `<tr>
                    <td><strong>${l.event_type}</strong></td>
                    <td>${l.description || '-'}</td>
                    <td>${l.ip_address || '-'}</td>
                    <td>${new Date(l.created_at).toLocaleString()}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('audit-list').innerHTML = html;
        }
        
        async function loadDatabase() {
            // Load tables overview
            const respTables = await fetch(window.ADMIN_API_URLS.databaseTables);
            const dataTables = await respTables.json();
            
            // Display tables with row counts
            let tablesHtml = '<table class="data-table"><thead><tr><th>Table Name</th><th>Rows</th><th>Columns</th><th>Actions</th></tr></thead><tbody>';
            dataTables.tables.forEach(t => {
                tablesHtml += `<tr>
                    <td><strong>${t.name}</strong></td>
                    <td>${t.row_count.toLocaleString()}</td>
                    <td>${t.columns.length}</td>
                    <td><button class="btn-sm" onclick="viewTable('${t.name}')">View Data</button></td>
                </tr>`;
            });
            tablesHtml += '</tbody></table>';
            document.getElementById('tables-list').innerHTML = tablesHtml;
            
            // Populate table selector
            const selector = document.getElementById('table-selector');
            selector.innerHTML = '<option value="">Select a table...</option>';
            dataTables.tables.forEach(t => {
                selector.innerHTML += `<option value="${t.name}">${t.name} (${t.row_count} rows)</option>`;
            });
            
            // Load database info
            const respInfo = await fetch(window.ADMIN_API_URLS.databaseInfo);
            const dataInfo = await respInfo.json();
            document.getElementById('db-info').innerHTML = `
                <p><strong>Size:</strong> ${dataInfo.size_mb} MB</p>
                <p><strong>Total Users:</strong> ${dataInfo.total_users}</p>
                <p><strong>Total Scans:</strong> ${dataInfo.total_scans}</p>
            `;
        }
        
        async function executeQuery() {
            const query = document.getElementById('sql-query').value.trim();
            if (!query) {
                alert('Please enter a SQL query');
                return;
            }
            
            try {
                const resp = await fetch(window.ADMIN_API_URLS.databaseQuery, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query})
                });
                
                const data = await resp.json();
                
                if (!resp.ok) {
                    document.getElementById('query-result').innerHTML = `<div style="color:red; padding:10px; background:#fee; border-radius:4px;">‚ùå Error: ${data.detail}</div>`;
                    return;
                }
                
                // Display results in table
                let html = `<div style="background:#e8f5e9; padding:10px; border-radius:4px; margin-bottom:10px;">‚úÖ Query executed successfully. ${data.row_count} rows returned.</div>`;
                
                if (data.rows.length > 0) {
                    html += '<div style="overflow-x:auto;"><table class="data-table"><thead><tr>';
                    data.columns.forEach(col => {
                        html += `<th>${col}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    data.rows.forEach(row => {
                        html += '<tr>';
                        row.forEach(cell => {
                            html += `<td>${cell || 'NULL'}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                } else {
                    html += '<p>No rows returned.</p>';
                }
                
                document.getElementById('query-result').innerHTML = html;
            } catch (e) {
                document.getElementById('query-result').innerHTML = `<div style="color:red; padding:10px; background:#fee; border-radius:4px;">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        function viewTable(tableName) {
            document.getElementById('table-selector').value = tableName;
            loadTableData(tableName);
        }
        
        async function loadTableData(tableName) {
            if (!tableName) {
                document.getElementById('table-data').innerHTML = '';
                return;
            }
            
            try {
                const resp = await fetch(`${window.ADMIN_API_URLS.databaseTable}/${tableName}?limit=50`);
                const data = await resp.json();
                
                if (!resp.ok) {
                    document.getElementById('table-data').innerHTML = `<div style="color:red;">Error: ${data.detail}</div>`;
                    return;
                }
                
                let html = `<div style="margin-bottom:10px;"><strong>Table:</strong> ${data.table_name} | <strong>Total Rows:</strong> ${data.total.toLocaleString()} | <strong>Showing:</strong> ${data.rows.length} rows (page ${data.page}/${data.pages})</div>`;
                html += '<div style="overflow-x:auto;"><table class="data-table"><thead><tr>';
                
                data.columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.rows.forEach(row => {
                    html += '<tr>';
                    data.columns.forEach(col => {
                        let val = row[col];
                        if (val && val.length > 100) {
                            val = val.substring(0, 100) + '...';
                        }
                        html += `<td>${val || 'NULL'}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                // Pagination
                if (data.pages > 1) {
                    html += '<div style="margin-top:15px;">';
                    for (let i = 1; i <= Math.min(data.pages, 10); i++) {
                        html += `<button class="btn-sm" onclick="loadTableDataPage('${tableName}', ${i})" ${i === data.page ? 'disabled' : ''}>Page ${i}</button> `;
                    }
                    html += '</div>';
                }
                
                document.getElementById('table-data').innerHTML = html;
            } catch (e) {
                document.getElementById('table-data').innerHTML = `<div style="color:red;">Error: ${e.message}</div>`;
            }
        }
        
        async function loadTableDataPage(tableName, page) {
            const resp = await fetch(`${window.ADMIN_API_URLS.databaseTable}/${tableName}?page=${page}&limit=50`);
            const data = await resp.json();
            // Reuse loadTableData display logic...
            viewTable(tableName);
        }
        
        async function backupDB() {
            if (confirm('Create database backup?')) {
                const resp = await fetch(window.ADMIN_API_URLS.databaseBackup, {method: 'POST', headers: {'X-CSRFToken': window.getCsrfToken()}});
                const data = await resp.json();
                alert('Backup created: ' + data.backup_file);
            }
        }
        
        loadDashboard();
    </script>
</body>
</html>
