#!/usr/bin/env python3
"""
Minimal Flask server for BugBounty Arsenal
No authentication, no database complexity - just direct scanner execution
"""

import os
import sys
import json
import uuid
import threading
from datetime import datetime
from pathlib import Path
from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS

# Import our scanner
from scanner import run_scan
from report_generator import generate_html_report

app = Flask(__name__, 
            static_folder='static',
            template_folder='templates')
CORS(app)  # Allow all origins

# Simple in-memory storage (no database needed)
scans_db = {}
scan_lock = threading.Lock()

# Directories
REPORTS_DIR = Path("reports")
REPORTS_DIR.mkdir(exist_ok=True)

def generate_scan_id():
    """Generate unique scan ID"""
    return str(uuid.uuid4())[:8]

def run_scan_thread(scan_id, target, scan_config):
    """Run scan in background thread"""
    scan_info = scans_db[scan_id]
    
    try:
        scan_info['status'] = 'running'
        scan_info['started_at'] = datetime.now().isoformat()
        
        # Create scan directory
        scan_dir = REPORTS_DIR / f"scan_{scan_id}"
        scan_dir.mkdir(exist_ok=True)
        
        raw_responses_dir = scan_dir / "raw_responses"
        raw_responses_dir.mkdir(exist_ok=True)
        
        # Run the actual scan
        results = run_scan(
            targets=[target],
            scope_patterns=None,
            raw_responses_dir=str(raw_responses_dir),
            **scan_config
        )
        
        # Generate report
        report_path = scan_dir / "report.html"
        generate_html_report(results, str(report_path))
        
        # Update scan info
        vuln_count = sum(len(v) for v in results.values())
        scan_info.update({
            'status': 'completed',
            'completed_at': datetime.now().isoformat(),
            'vulnerabilities_found': vuln_count,
            'results': results,
            'report_path': str(report_path)
        })
        
    except Exception as e:
        scan_info['status'] = 'failed'
        scan_info['error'] = str(e)
        scan_info['completed_at'] = datetime.now().isoformat()

@app.route('/static/<path:filename>')
def serve_static(filename):
    """Serve static files"""
    return send_from_directory('static', filename)

@app.route('/')
def index():
    """Serve landing page"""
    from flask import render_template_string
    with open('templates/landing_clean.html', 'r') as f:
        content = f.read()
    # Replace Django template tags with Flask paths
    content = content.replace("{% load static %}", "")
    content = content.replace("{% static '", "'/static/")
    content = content.replace("' %}", "'")
    content = content.replace("{% url 'landing' %}", "/")
    content = content.replace("{% url 'dashboard' %}", "/dashboard/")
    content = content.replace("{% url 'signup' %}", "/signup/")
    content = content.replace("{% url 'login' %}", "/login/")
    return content

@app.route('/login/')
def login():
    """Serve login page (no actual auth needed)"""
    with open('templates/login.html', 'r') as f:
        content = f.read()
    content = content.replace("{% load static %}", "")
    content = content.replace("{% static '", "'/static/")
    content = content.replace("' %}", "'")
    content = content.replace("{% url 'landing' %}", "/")
    content = content.replace("{% url 'dashboard' %}", "/dashboard/")
    return content

@app.route('/signup/')
def signup():
    """Serve signup page (no actual registration needed)"""
    with open('templates/signup.html', 'r') as f:
        content = f.read()
    content = content.replace("{% load static %}", "")
    content = content.replace("{% static '", "'/static/")
    content = content.replace("' %}", "'")
    content = content.replace("{% url 'landing' %}", "/")
    content = content.replace("{% url 'dashboard' %}", "/dashboard/")
    content = content.replace("{% url 'login' %}", "/login/")
    retutry:
            with open(f'templates/{filename}', 'r') as f:
                content = f.read()
            content = content.replace("{% load static %}", "")
            content = content.replace("{% static '", "'/static/")
            content = content.replace("' %}", "'")
            content = content.replace("{% url 'landing' %}", "/")
            content = content.replace("{% url 'dashboard' %}", "/dashboard/")
            content = content.replace("{% url 'logout' %}", "/")
            content = content.replace("{% url 'admin-panel' %}", "/admin-panel/")
            return content
        except FileNotFoundError:
            return "Page not found", 404

@app.route('/dashboard/')
def dashboard():
    """Serve dashboard"""
    with open('templates/dashboard.html', 'r') as f:
        content = f.read()
    content = content.replace("{% load static %}", "")
    content = content.replace("{% static '", "'/static/")
    content = content.replace("' %}", "'")
    content = content.replace("{% url 'landing' %}", "/")
    content = content.replace("{% url 'logout' %}", "/")
    content = content.replace("{% url 'admin-panel' %}", "/admin-panel/")
    return content

@app.route('/dashboard/<page>/')
def scan_page(page):
    """Serve scan pages"""
    allowed = ['api-scan', 'vulnerability-scan', 'mobile-scan', 
               'custom-scan', 'passive-scan', 'web-scan', 'results']
    
    if page in allowed:
        filename = page.replace('-', '_') + '.html'
        return send_from_directory('templates', filename)
    
    return "Page not found", 404

@app.route('/health/')
def health():
    """Health check"""
    return jsonify({"status": "ok"})

# ============= API ENDPOINTS =============

@app.route('/api/auth/login/', methods=['POST'])
def api_login():
    """Fake login - always succeeds"""
    data = request.json or {}
    return jsonify({
        "access": "fake-token-" + str(uuid.uuid4()),
        "refresh": "fake-refresh-" + str(uuid.uuid4()),
        "user": {
            "id": 1,
            "email": data.get('email', 'user@local'),
            "is_admin": False
        }
    })

@app.route('/api/auth/signup/', methods=['POST'])
def api_signup():
    """Fake signup - always succeeds"""
    data = request.json or {}
    return jsonify({
        "access": "fake-token-" + str(uuid.uuid4()),
        "refresh": "fake-refresh-" + str(uuid.uuid4()),
        "user": {
            "id": 1,
            "email": data.get('email', 'user@local'),
            "is_admin": False
        }
    })

@app.route('/api/scans/status/', methods=['GET'])
def get_scans():
    """Get all scans"""
    with scan_lock:
        scans_list = []
        for scan_id, info in scans_db.items():
            scans_list.append({
                'id': scan_id,
                'target': info['target'],
                'scan_type': info.get('scan_type', 'web_security'),
                'status': info['status'],
                'started_at': info.get('started_at'),
                'completed_at': info.get('completed_at'),
                'vulnerabilities_found': info.get('vulnerabilities_found'),
            })
        
        # Sort by started_at desc
        scans_list.sort(key=lambda x: x.get('started_at', ''), reverse=True)
        return jsonify(scans_list)

@app.route('/api/scans/start/', methods=['POST'])
def start_scan():
    """Start new scan"""
    data = request.json or {}
    target = data.get('target')
    
    if not target:
        return jsonify({"error": "Target is required"}), 400
    
    scan_id = generate_scan_id()
    
    # Prepare scan config
    scan_config = {
        'concurrency': data.get('concurrency', 10),
        'timeout': data.get('timeout', 15),
        'per_host_rate': data.get('per_host_rate', 1.0),
        'allow_destructive': data.get('allow_destructive', False),
        'bypass_cloudflare': data.get('bypass_cloudflare', False),
        'enable_forbidden_probe': data.get('enable_forbidden_probe', False),
    }
    
    # Create scan entry
    with scan_lock:
        scans_db[scan_id] = {
            'id': scan_id,
            'target': target,
            'scan_type': data.get('scan_type', 'web_security'),
            'status': 'pending',
            'created_at': datetime.now().isoformat(),
        }
    
    # Start scan in background
    thread = threading.Thread(
        target=run_scan_thread,
        args=(scan_id, target, scan_config),
        daemon=True
    )
    thread.start()
    
    return jsonify({
        'id': scan_id,
        'target': target,
        'scan_type': data.get('scan_type', 'web_security'),
        'status': 'pending',
        'started_at': datetime.now().isoformat()
    }), 201

@app.route('/api/scans/<scan_id>/', methods=['GET'])
def get_scan(scan_id):
    """Get single scan details"""
    with scan_lock:
        if scan_id not in scans_db:
            return jsonify({"error": "Scan not found"}), 404
        
        return jsonify(scans_db[scan_id])

@app.route('/api/scans/<scan_id>/export/', methods=['GET'])
def export_scan(scan_id):
    """Export scan report"""
    with scan_lock:
        if scan_id not in scans_db:
            return jsonify({"error": "Scan not found"}), 404
        
        scan_info = scans_db[scan_id]
        report_path = scan_info.get('report_path')
        
        if not report_path or not os.path.exists(report_path):
            return jsonify({"error": "Report not found"}), 404
        
        report_dir = os.path.dirname(report_path)
        report_file = os.path.basename(report_path)
        
        return send_from_directory(report_dir, report_file, as_attachment=True)

@app.route('/api/billing/checkout/', methods=['POST'])
def checkout():
    """Fake checkout - just return success"""
    return jsonify({
        "checkout_url": "http://localhost:8000/dashboard/?upgraded=true",
        "session_id": "fake-session-" + str(uuid.uuid4())
    })

if __name__ == '__main__':
    print("=" * 60)
    print("üõ°Ô∏è  BugBounty Arsenal - Simple Server")
    print("=" * 60)
    print(f"üìÇ Reports directory: {REPORTS_DIR.absolute()}")
    print(f"üåê Server starting on: http://localhost:8000")
    print(f"üìù No authentication required")
    print(f"üöÄ Ready to scan!")
    print("=" * 60)
    
    app.run(
        host='0.0.0.0',
        port=8000,
        debug=True,
        threaded=True
    )
